<!DOCTYPE html>
<html lang="en">
<head>  
  <meta charset="UTF-8">
  <title>Sirome TV</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="author" content="Sirome Live Sports">
  <meta name="referrer" content="no-referrer">
  <meta property="og:image" content="https://i.postimg.cc/d1hHy4ss/11.png">
  
  <!-- Favicon -->
  <link rel="icon" href="https://i.postimg.cc/d1hHy4ss/11.png" type="image/png">
  
  <!-- New Monetag SDK -->
  <script src='//libtl.com/sdk.js' data-zone='9978881' data-sdk='show_9978881'></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  
  <!-- Clappr Core Player and Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/level-selector@0.2.0/dist/level-selector.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@clappr/hlsjs-playback@1.0.1/dist/hlsjs-playback.min.js"></script>
  <!-- PIP Mode Plugin for Clappr -->
  <script src="https://cdn.jsdelivr.net/npm/clappr-pip-mode@1.1.0/dist/clappr-pip-mode.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
  </style>
  
  <style>
    body,
    html {
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background: #0f0f0f;
      color: #fff;
    }
    
    /* Disable text selection and image drag */
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
    }
  </style>
  
  <style>
    .main-container {
      display: flex;
      flex-direction: row;
      height: 100vh;
      width: 100vw;
    }
    
    /* Player */
    .video-container {
      flex: 0 0 70%;
      background: black;
      display: flex;
      flex-direction: column;
      padding: 2px;
    }
    
    .video-wrapper {
      width: 100%;
      flex: 1;
      position: relative;
      background: black;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2px;
    }
    
    #player {
      width: 100%;
      max-width: 1280px;
      aspect-ratio: 16/9;
      border: none;
      display: block;
      margin: 0 auto;
      box-shadow: none;
      position: relative;
      outline: none;
    }
    
    /* Fullscreen Logo */
    #fullscreen-logo {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 60px;
      height: auto;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      display: none;
    }
    
    .video-watermark {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 50px;
      opacity: .7;
      z-index: 10;
    }
    
    /* Channel box */
    .channel-box {
      flex: 0 0 30%;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
    }
    
    /* Channel list scroll area */
    .channel-list {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 1rem;
      padding-bottom: 30px;
    }
    
    .channel-list::-webkit-scrollbar {
      width: 10px;
    }
    
    .channel-list::-webkit-scrollbar-thumb {
      background: red;
      border-radius: 5px;
    }
    
    /* Search Box Styles */
    .search-container {
      background: #2a2a2a;
      border: 1px solid white;
      border-radius: 3px;
      margin-left: 2%;
      margin-right: 2%;
      font-size: 10px;
      padding: None;
    }
    
    .search-box {
      width: 100%;
      padding: 5px 15px;
      border-radius: 5px;
      border: none;
      background: black;
      color: white;
      font-size: 10px;
      outline: none;
    }
    
    .search-box:focus {
      border-color: white;
    }
    
    .search-box::placeholder {
      color: #888;
    }
    
    .search-results-info {
      text-align: center;
      padding: 5px;
      font-size: 12px;
      color: #aaa;
      background: #2a2a2a;
      border-bottom: 1px solid #444;
    }
    
    .clear-search {
      position: absolute;
      right: 25px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 16px;
      padding: 5px;
    }
    
    /* Channel item styles with focus state for TV remote navigation */
    .channel-item {
      background: #333;
      border-radius: 5px;
      text-align: center;
      box-shadow: 0 0 100px rgba(0, 0, 0, 0.4);
      transition: all 0.2s ease;
      cursor: pointer;
      transform: scale(0.98);
      animation: fadeInUp 0.3s ease both;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      outline: none;
      border: 2px solid transparent;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .channel-item:hover {
      border: 1px solid white;
      box-shadow: 0 0 2px white, 0 0 3px white;
      background: red;
    }
    
    /* Focus state for TV remote navigation */
    .channel-item:focus {
      outline: none;
    }
    
    .channel-item.channel-selected {
      border: 1px solid white;
      box-shadow: 0 0 2px white, 0 0 6px white;
      background: black;
    }
    
    .channel-item img {
      width: 100%;
      height: 70px;
      object-fit: contain;
      margin-bottom: 2px;
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .channel-item img.loaded {
      opacity: 1;
    }
    
    .channel-name {
      margin: 0;
      font-size: 10px !important;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 100%;
      text-align: center;
      color: #fff;
      user-select: none;
    }
    
    .channel-item small {
      display: block;
      font-size: 0.8rem;
      color: #ccc;
    }
  </style>
  
  <style>
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid #FFF;
      border-bottom-color: red;
      border-radius: 50%;
      display: block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes rotation {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    
    @keyframes fadeInUp {
      0% {
        transform: translateY(0);
        opacity: 0;
      }
      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* Loading indicator */
    .loading {
      text-align: center;
      padding: 2px;
      color: #aaa;
    }
    
    /* Video loading overlay */
    .video-loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      transition: opacity 0.3s ease;
    }
    
    .video-loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    /* Firebase Counter Styles */
    #counters {
      text-align: center;
      background-color: #4f4e4e;
      border: 1px solid white;
      border-radius: 3px;
      margin: 1px 0;
      margin-left: 2%;
      margin-right: 2%;
      font-size: 10px;
      padding: None;
    }
    
    #counters div {
      margin: 1px 0;
    }
    
    /* Playlist container and divider */
    .playlist-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(30%, 1fr));
      gap: 1rem;
      min-height: 100%;
    }
    
    .playlist-divider {
      height: 8px;
      background: linear-gradient(90deg, transparent, #555, transparent);
      margin: 0.5rem 0;
      width: 100%;
      grid-column: 1 / -1;
    }
  </style>
  
  <style>
    /* Desktop Only */
    @media (min-width: 1024px) {
      /* Desktop-‡¶è hover ‡¶á‡¶´‡ßá‡¶ï‡ßç‡¶ü ‡¶≠‡¶æ‡¶≤‡ßã‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
      .channel-item:hover {
        border: 1px solid white;
        box-shadow: 0 0 2px white, 0 0 6px white;
        background: red;
        transform: translateY(-8px) scale(1.03);
      }
      
      /* Desktop-‡¶è ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤‡¶¨‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡¶ø‡¶Ç */
      .channel-list::-webkit-scrollbar {
        width: 12px;
      }
      
      /* Desktop-‡¶è ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú */
      #player {
        max-width: 1280px;
      }
      
      /* Desktop-‡¶è ‡¶≤‡ßã‡¶ó‡ßã ‡¶∏‡¶æ‡¶á‡¶ú */
      #fullscreen-logo {
        width: 60px;
      }
    }
  </style>
  
  <style>
    /* Mobile Styles */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }
      
      .video-container {
        flex: 0 0 40%;
        padding: 2px;
      }
      
      .channel-box {
        flex: 0 0 60%;
        overflow: hidden;
      }
      
      .playlist-container {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        padding: 0.5rem;
      }
      
      .channel-item {
        padding: 2%;
      }
      
      .channel-item img {
        width: 100%;
        height: 70px;
        object-fit: contain;
      }
      
      .channel-name {
        font-size: 8px !important;
      }
      
      #player {
        aspect-ratio: 16/9;
        max-width: 100%;
      }
      
      .video-wrapper {
        padding: 2px;
      }
      
      #fullscreen-logo {
        width: 40px !important;
        top: 10px !important;
        right: 10px !important;
      }
      
      #counters {
        font-size: 8px;
        margin: 2px 0;
        margin-left: 1%;
        margin-right: 1%;
      }
      
      .search-container {
        margin-left: 1%;
        margin-right: 1%;
      }
      
      .search-box {
        font-size: 8px;
        padding: 3px 10px;
      }
      
      .channel-list {
        padding: 0.5rem;
      }
    }
  </style>
  
  <style>
    /* Mobile Portrait Mode */
    @media (max-width: 768px) and (orientation: portrait) {
      .video-container {
        flex: 0 0 40%;
      }
      
      .channel-box {
        flex: 0 0 60%;
      }
    }
  </style>
  
  <style>
    /* Mobile Landscape Mode */
    @media (max-width: 768px) and (orientation: landscape) {
      .video-container {
        flex: 0 0 50%;
      }
      
      .channel-box {
        flex: 0 0 50%;
      }
    }
  </style>
  
  <style>
    /* Small Mobile Devices */
    @media (max-width: 480px) {
      .playlist-container {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.3rem;
        padding: 0.3rem;
      }
      
      .channel-item {
        padding: 3%;
      }
      
      .channel-name {
        font-size: 7px !important;
      }
      
      .channel-item img {
        width: 100%;
        height: 70px;
      }
    }
  </style>
</head>

<body>
  <div class="main-container">
    <!-- Player -->
    <div class="video-container">
      <div class="video-wrapper">
        <div id="player" tabindex="-1"></div>
        <!-- Loading overlay for video -->
        <div class="video-loading-overlay" id="videoLoadingOverlay">
          <div class="loader"></div>
        </div>
        <!-- Fullscreen Logo (will be controlled by JavaScript) -->
        <img id="fullscreen-logo" src="https://i.postimg.cc/d1hHy4ss/11.png" alt="Sirome TV Logo">
      </div>
      
      <!-- Firebase Counters -->
      <div id="counters">
        <div id="online-counter">Online Now: 0 | Today: 0 | Total: 0</div>
      </div>
      
      <!-- Search Box -->
      <div class="search-container">
        <div style="position: relative;">
          <input type="text" id="channelSearch" class="search-box" placeholder="Search Channels...">
          <button class="clear-search" id="clearSearch" style="display: none;">‚úï</button>
        </div>
      </div>
      
      <!-- Search Results Info -->
      <div class="search-results-info" id="searchResultsInfo" style="display: none;"></div>
    </div>
    
    <!-- Channel box -->
    <div class="channel-box">
      <!-- Channel list -->
      <div class="channel-list" id="channelList">
        <span class="loader"></span>
        <div class="loading">Loading Channels...Please wait</div>
      </div>
    </div>
  </div>
  
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBL6nN2TH4uyp8iso6Q99_QHkYyHnslXjU",
      authDomain: "tg-bot-sirome-tv.firebaseapp.com",
      databaseURL: "https://tg-bot-sirome-tv-default-rtdb.firebaseio.com",
      projectId: "tg-bot-sirome-tv",
      storageBucket: "tg-bot-sirome-tv.firebasestorage.app",
      messagingSenderId: "764854962010",
      appId: "1:764854962010:web:6a77f650622614de4d5563",
      measurementId: "G-8G48FV41TH"
    };
  </script>
  
  <script>
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.database();
    
    // Playlist URLs - ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡¶Æ‡¶§ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    const m3u1Url = 'https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u';
    const m3u2Url = 'https://raw.githubusercontent.com/sirometv/playlist/main/sirometvsports.m3u';
    const m3u3Url = '*/';
    const m3u4Url = '*/';
    const m3u5Url = '*/';
    const m3u6Url = '*/';
  </script>
  
  <script>
    // Global variables
    let player;
    let channels = [];
    let playlistSources = [];
    let filteredChannels = [];
    let channelLogoCache = new Map();
    let videoLoadingTimeout;
    
    // TV Remote Navigation Variables
    let currentFocusIndex = 0;
    let channelItems = [];
    let isSearchActive = false;
    let lastEnterPressTime = 0;
    let lastKeyPressTime = 0;
    let isInFullscreen = false;
    let currentMode = 'channels'; // 'channels' or 'player'
    let lastNormalModeTime = 0;
    let isDoubleClickMode = false;
    let focusDebounceTimer = null;
  </script>
  
  <script>
    // Disable right-click context menu
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      return false;
    });
    
    // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
    document.addEventListener('keydown', function(e) {
      if (
        e.key === 'F12' ||
        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
        (e.ctrlKey && e.shiftKey && e.key === 'J') ||
        (e.ctrlKey && e.key === 'U') ||
        (e.metaKey && e.altKey && e.key === 'I') ||
        (e.metaKey && e.altKey && e.key === 'J')
      ) {
        e.preventDefault();
        return false;
      }
    });
    
    // Disable drag and drop for images
    document.addEventListener('dragstart', function(e) {
      if (e.target.tagName === 'IMG') {
        e.preventDefault();
        return false;
      }
    });
    
    // Disable text selection
    document.addEventListener('selectstart', function(e) {
      e.preventDefault();
      return false;
    });
  </script>
  
  <script>
    // Fullscreen Logo Plugin
    const FullscreenLogoPlugin = Clappr.CorePlugin.extend({
      name: 'fullscreen_logo',
      
      bindEvents: function() {
        this.listenTo(this.core, Clappr.Events.CORE_FULLSCREEN, this.onFullscreenChange);
      },
      
      onFullscreenChange: function(isFullscreen) {
        isInFullscreen = isFullscreen;
        const logoElement = document.getElementById('fullscreen-logo');
        if (logoElement) {
          if (isFullscreen) {
            logoElement.style.display = 'block';
            setTimeout(() => {
              logoElement.style.opacity = '0.8';
            }, 10);
          } else {
            logoElement.style.opacity = '0';
            setTimeout(() => {
              logoElement.style.display = 'none';
            }, 300);
            
            // When exiting fullscreen, stay in current mode
            setTimeout(() => {
              if (currentMode === 'channels') {
                focusOnChannels();
              } else {
                focusOnPlayer();
              }
            }, 100);
          }
        }
      }
    });
  </script>
  
  <script>
    // Firebase Online Counter
    const usersRef = db.ref("onlineUsers");
    const totalRef = db.ref("totalVisitors");
    const todayRef = db.ref("dailyVisitors/" + new Date().toISOString().slice(0, 10));
    const sessionId = "user_" + Math.random().toString(36).substring(2, 12);
    
    usersRef.child(sessionId).set({
      lastSeen: Date.now()
    });
    
    totalRef.transaction(c => (c || 0) + 1);
    todayRef.transaction(c => (c || 0) + 1);
    
    window.addEventListener("beforeunload", () => usersRef.child(sessionId).remove());
    
    const onlineCounter = document.getElementById("online-counter");
    const ACTIVE_THRESHOLD = 5 * 1000;
    
    function updateOnlineCounter() {
      usersRef.once("value").then(snap => {
        const onlineUsers = snap.val() || {};
        const now = Date.now();
        const activeUsers = Object.values(onlineUsers).filter(u => (now - u.lastSeen) <= ACTIVE_THRESHOLD);
        const totalOnline = activeUsers.length;
        totalRef.once("value").then(snap2 => {
          const totalVisitors = snap2.val() || 0;
          todayRef.once("value").then(snap3 => {
            const todayVisitors = snap3.val() || 0;
            onlineCounter.innerHTML = `üë• Online: ${totalOnline} | üìÖ Today: ${todayVisitors} | üåç Total: ${totalVisitors}`;
          });
        });
      });
    }
    
    updateOnlineCounter();
    usersRef.on("value", updateOnlineCounter);
    
    setInterval(() => usersRef.child(sessionId).update({
      lastSeen: Date.now()
    }), 15000);
  </script>
  
  <script>
    // Firebase Ads Counter
    const adsRef = db.ref("adsStats");
    const adsCounter = document.getElementById("ads-counter");
    
    function updateAdsCounter() {
      adsRef.once("value").then(snap => {
        const data = snap.val() || {};
        if (adsCounter) {
          adsCounter.innerHTML = `‚ñ∂ Watched: ${data.totalShown || 0} |  ‚úÖ Checked: ${data.totalClicked || 0}`;
        }
      });
    }
    
    adsRef.on("value", updateAdsCounter);
    
    function incrementAdShown() {
      adsRef.child("totalShown").transaction(c => (c || 0) + 1);
    }
    
    function incrementAdClicked() {
      adsRef.child("totalClicked").transaction(c => (c || 0) + 1);
    }
    
    // Updated for new Monetag zone
    if (typeof window.show_9978881_click_callback === 'undefined') {
      window.show_9978881_click_callback = incrementAdClicked;
    }
    
    let lastAdTime = 0;
    
    function triggerSwitchAd() {
      const now = Date.now();
      const adCooldown = 120000;
      if (now - lastAdTime < adCooldown) return;
      lastAdTime = now;
      if (typeof show_9978881 === 'function') {
        show_9978881();
        incrementAdShown();
      }
    }
  </script>
  
  <script>
    // ================================
    // TV REMOTE NAVIGATION FUNCTIONS
    // ================================
    
    function updateChannelItems() {
      channelItems = document.querySelectorAll('.channel-item');
      if (channelItems.length > 0) {
        setFocus(currentFocusIndex);
      }
    }
    
    function setFocus(index) {
      // Debounce focus changes
      if (focusDebounceTimer) {
        clearTimeout(focusDebounceTimer);
      }
      
      focusDebounceTimer = setTimeout(() => {
        // Remove focus from all items
        channelItems.forEach(item => {
          item.classList.remove('channel-selected');
          item.setAttribute('tabindex', '-1');
        });
        
        // Set focus to new index
        if (channelItems.length > 0 && index >= 0 && index < channelItems.length) {
          currentFocusIndex = index;
          const selectedItem = channelItems[currentFocusIndex];
          
          selectedItem.classList.add('channel-selected');
          selectedItem.setAttribute('tabindex', '0');
          
          // Smooth scroll into view
          requestAnimationFrame(() => {
            selectedItem.scrollIntoView({
              behavior: 'smooth',
              block: 'nearest',
              inline: 'nearest'
            });
          });
        }
      }, 50);
    }
    
    function navigateUp() {
      if (channelItems.length === 0 || currentMode !== 'channels') return;
      
      const columns = getGridColumns();
      if (currentFocusIndex >= columns) {
        setFocus(currentFocusIndex - columns);
      } else {
        // Go to last row if at top
        const rows = Math.ceil(channelItems.length / columns);
        const lastRowStart = (rows - 1) * columns;
        const targetIndex = Math.min(lastRowStart + (currentFocusIndex % columns), channelItems.length - 1);
        setFocus(targetIndex);
      }
    }
    
    function navigateDown() {
      if (channelItems.length === 0 || currentMode !== 'channels') return;
      
      const columns = getGridColumns();
      if (currentFocusIndex + columns < channelItems.length) {
        setFocus(currentFocusIndex + columns);
      } else {
        // Go to first row if at bottom
        setFocus(currentFocusIndex % columns);
      }
    }
    
    function navigateLeft() {
      if (channelItems.length === 0 || currentMode !== 'channels') return;
      
      if (currentFocusIndex > 0) {
        setFocus(currentFocusIndex - 1);
      } else {
        // Go to last item
        setFocus(channelItems.length - 1);
      }
    }
    
    function navigateRight() {
      if (channelItems.length === 0 || currentMode !== 'channels') return;
      
      if (currentFocusIndex < channelItems.length - 1) {
        setFocus(currentFocusIndex + 1);
      } else {
        // Go to first item
        setFocus(0);
      }
    }
    
    function handleEnterPress() {
      const now = Date.now();
      
      if (isInFullscreen) {
        // In fullscreen mode
        if (now - lastEnterPressTime < 1000) {
          // Double press in fullscreen: Play/Pause
          togglePlayPause();
        } else {
          // Single press in fullscreen: Exit to normal mode
          exitToNormalMode();
        }
      } else {
        // In normal mode
        if (now - lastEnterPressTime < 1000) {
          // Double press in normal mode: Enter fullscreen
          enterFullscreen();
        } else {
          // Single press in normal mode: Select channel
          selectChannel();
        }
      }
      
      lastEnterPressTime = now;
    }
    
    function selectChannel() {
      if (channelItems.length > 0 && currentFocusIndex < channelItems.length) {
        const selectedItem = channelItems[currentFocusIndex];
        const url = selectedItem.getAttribute('data-url');
        const logo = selectedItem.getAttribute('data-logo');
        
        if (url && url !== 'null') {
          playChannel(url, logo);
          triggerSwitchAd();
        }
      }
    }
    
    function enterFullscreen() {
      if (player && player.core) {
        player.core.toggleFullscreen();
      }
    }
    
    function exitToNormalMode() {
      if (isInFullscreen && player && player.core) {
        // Exit fullscreen
        player.core.toggleFullscreen();
      }
      
      // Switch to channels mode after a short delay
      setTimeout(() => {
        switchToChannelsMode();
      }, 300);
    }
    
    function togglePlayPause() {
      if (player) {
        if (player.isPlaying()) {
          player.pause();
        } else {
          player.play();
        }
      }
    }
    
    function focusOnPlayer() {
      currentMode = 'player';
      const playerElement = document.getElementById('player');
      if (playerElement) {
        playerElement.focus();
      }
      
      // Remove focus from channel items
      channelItems.forEach(item => {
        item.classList.remove('channel-selected');
        item.setAttribute('tabindex', '-1');
      });
    }
    
    function focusOnChannels() {
      currentMode = 'channels';
      if (channelItems.length > 0) {
        setFocus(currentFocusIndex);
      }
    }
    
    function switchToChannelsMode() {
      currentMode = 'channels';
      lastNormalModeTime = Date.now();
      focusOnChannels();
    }
    
    function handleNavigationKey(key) {
      const now = Date.now();
      
      // Update key press time
      lastKeyPressTime = now;
      
      // Handle based on current mode
      if (currentMode === 'channels') {
        // In channels mode, navigate channels
        switch(key) {
          case 'ArrowUp':
            navigateUp();
            break;
          case 'ArrowDown':
            navigateDown();
            break;
          case 'ArrowLeft':
            navigateLeft();
            break;
          case 'ArrowRight':
            navigateRight();
            break;
        }
      } else if (currentMode === 'player' && !isInFullscreen) {
        // In player mode (not fullscreen), arrow keys switch to channels mode
        switch(key) {
          case 'ArrowUp':
          case 'ArrowDown':
          case 'ArrowLeft':
          case 'ArrowRight':
            switchToChannelsMode();
            break;
        }
      }
    }
    
    function handleSpecialKey(key) {
      switch(key) {
        case 'Enter':
        case ' ':
          handleEnterPress();
          break;
          
        case 'f':
        case 'F':
          if (player && player.core) {
            player.core.toggleFullscreen();
          }
          break;
          
        case 'Escape':
        case 'Backspace':
          if (isInFullscreen) {
            // Exit fullscreen
            exitToNormalMode();
          } else if (currentMode === 'player') {
            // Switch to channels mode
            switchToChannelsMode();
          }
          // In channels mode, do nothing (stay in channels mode)
          break;
          
        case 'Tab':
          // Toggle between player and channels mode
          if (currentMode === 'channels') {
            focusOnPlayer();
          } else {
            switchToChannelsMode();
          }
          break;
      }
    }
    
    function getGridColumns() {
      const container = document.querySelector('.playlist-container');
      if (!container) return 3;
      
      const computedStyle = window.getComputedStyle(container);
      const gridTemplateColumns = computedStyle.gridTemplateColumns;
      const columns = gridTemplateColumns.split(' ').length;
      
      return Math.max(columns, 3);
    }
    
    // TV Remote Key Handling
    function handleTVRemoteKey(event) {
      const key = event.key;
      
      // Prevent default for navigation keys
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter', ' ', 'Escape', 'Tab', 'Backspace'].includes(key)) {
        event.preventDefault();
      }
      
      // Handle navigation keys
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
        handleNavigationKey(key);
      } else {
        handleSpecialKey(key);
      }
    }
  </script>
  
  <script>
    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      loadChannels();
      setupSearch();
      
      // Add TV remote key listener
      document.addEventListener('keydown', handleTVRemoteKey);
      
      // Start in channels mode
      switchToChannelsMode();
      
      // Hide loading overlay initially
      const loadingOverlay = document.getElementById('videoLoadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
      }
      
      // Handle clicks to switch focus
      document.addEventListener('click', function(e) {
        if (e.target.closest('.channel-item')) {
          const clickedItem = e.target.closest('.channel-item');
          const index = Array.from(channelItems).indexOf(clickedItem);
          if (index >= 0) {
            currentFocusIndex = index;
            setFocus(currentFocusIndex);
            selectChannel();
          }
        } else if (e.target.closest('#player') || e.target.closest('.video-wrapper')) {
          focusOnPlayer();
        }
      });
      
      // Auto-focus channels after loading
      setTimeout(() => {
        const channelList = document.getElementById('channelList');
        if (channelList) {
          channelList.scrollTop = 0;
        }
        switchToChannelsMode();
      }, 1500);
    });
  </script>
  
  <script>
    // Setup search functionality
    function setupSearch() {
      const searchInput = document.getElementById('channelSearch');
      const clearButton = document.getElementById('clearSearch');
      const searchResultsInfo = document.getElementById('searchResultsInfo');
      
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim().toLowerCase();
        
        if (searchTerm.length > 0) {
          isSearchActive = true;
          clearButton.style.display = 'block';
          filterChannels(searchTerm);
        } else {
          isSearchActive = false;
          clearButton.style.display = 'none';
          clearSearch();
        }
      });
      
      clearButton.addEventListener('click', function() {
        searchInput.value = '';
        isSearchActive = false;
        clearButton.style.display = 'none';
        clearSearch();
        switchToChannelsMode();
      });
      
      // Add keyboard shortcut (Ctrl+F) to focus search
      document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          e.preventDefault();
          searchInput.focus();
        }
        
        // Focus search with / key
        if (e.key === '/' && document.activeElement !== searchInput) {
          e.preventDefault();
          searchInput.focus();
        }
      });
    }
    
    // Filter channels based on search term
    function filterChannels(searchTerm) {
      filteredChannels = channels.filter(channel => 
        channel.name.toLowerCase().includes(searchTerm)
      );
      
      renderFilteredChannels();
      
      const searchResultsInfo = document.getElementById('searchResultsInfo');
      if (filteredChannels.length === 0) {
        searchResultsInfo.textContent = `No channels found for "${searchTerm}"`;
        searchResultsInfo.style.display = 'block';
      } else {
        searchResultsInfo.textContent = `Found ${filteredChannels.length} channel(s) for "${searchTerm}"`;
        searchResultsInfo.style.display = 'block';
      }
    }
    
    // Clear search and show all channels
    function clearSearch() {
      const searchResultsInfo = document.getElementById('searchResultsInfo');
      searchResultsInfo.style.display = 'none';
      renderChannels();
      switchToChannelsMode();
    }
  </script>
  
  <script>
    // Render filtered channels
    function renderFilteredChannels() {
      const channelList = document.getElementById('channelList');
      
      if (filteredChannels.length === 0) {
        channelList.innerHTML = '<div class="loading">No channels found</div>';
        channelItems = [];
        return;
      }
      
      let html = '<div class="playlist-container">';
      
      filteredChannels.forEach((channel, index) => {
        html += `
          <div class="channel-item" 
               data-url="${channel.url}" 
               data-logo="${channel.logo}"
               data-index="${index}"
               tabindex="-1">
            <img src="${channel.logo}" 
                 onerror="this.src='https://i.postimg.cc/d1hHy4ss/11.png'; this.onerror=null;"
                 class="channel-logo"
                 loading="lazy"
                 onload="this.classList.add('loaded')">
            <div class="channel-name">${channel.name}</div>
          </div>
        `;
      });
      
      html += '</div>';
      
      channelList.innerHTML = html;
      
      // Add click event listeners to filtered channels
      const channelItems = document.querySelectorAll('.channel-item');
      channelItems.forEach((item, index) => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          currentFocusIndex = index;
          setFocus(currentFocusIndex);
          const url = this.getAttribute('data-url');
          const logo = this.getAttribute('data-logo');
          playChannel(url, logo);
          triggerSwitchAd();
          focusOnPlayer();
        });
      });
      
      // Update navigation items
      updateChannelItems();
      switchToChannelsMode();
      
      setTimeout(() => {
        channelList.scrollTop = 0;
      }, 100);
    }
  </script>
  
  <script>
    // Load channels from multiple playlists in parallel
    async function loadChannels() {
      try {
        channels = [];
        playlistSources = [];
        filteredChannels = [];
        
        let startIndex = 0;
        
        const playlists = [
          { url: m3u1Url, name: "SiromeTV" },
          { url: m3u2Url, name: "Sports" },
          { url: m3u3Url, name: "Ayna" },
          { url: m3u4Url, name: "Yupp" },
          { url: m3u5Url, name: "CricHd" },
          { url: m3u6Url, name: "CricHd" }
        ].filter(p => p.url && p.url !== '*/');
        
        // Load all playlists in parallel for faster loading
        const playlistPromises = playlists.map(async (playlist) => {
          try {
            const m3uChannels = await loadM3uPlaylist(playlist.url);
            return { playlist, channels: m3uChannels };
          } catch (error) {
            console.error(`Error loading playlist ${playlist.name}:`, error);
            return { playlist, channels: [] };
          }
        });
        
        const results = await Promise.all(playlistPromises);
        
        results.forEach(({ playlist, channels: m3uChannels }) => {
          if (m3uChannels && m3uChannels.length > 0) {
            playlistSources.push({
              name: playlist.name,
              startIndex: startIndex,
              count: m3uChannels.length
            });
            
            channels = channels.concat(m3uChannels);
            startIndex += m3uChannels.length;
          }
        });
        
        renderChannels();
        
        if (channels.length > 0) {
          // Preload first channel logo
          preloadLogo(channels[0].logo);
          initPlayer(channels[0].url, channels[0].logo);
        }
      } catch (error) {
        console.error('Error loading channels:', error);
        document.getElementById('channelList').innerHTML = '<div class="loading">Error loading channels. Please try again later.</div>';
      }
    }
    
    // Preload logo function
    function preloadLogo(url) {
      const img = new Image();
      img.src = url;
      img.onload = () => {
        channelLogoCache.set(url, true);
      };
    }
  </script>
  
  <script>
    // Load M3U playlist with better parsing for multiple URLs
    async function loadM3uPlaylist(url) {
      try {
        // Add cache buster for development, remove in production
        const cacheBuster = '?v=' + Date.now();
        const response = await fetch(url + cacheBuster, {
          cache: 'force-cache' // Use cache for faster loading
        });
        const text = await response.text();
        
        const channels = [];
        const lines = text.split('\n');
        
        let currentChannel = {};
        let urlLines = [];
        let i = 0;
        
        while (i < lines.length) {
          const line = lines[i].trim();
          
          if (line.startsWith('#EXTINF:')) {
            // If we have a previous channel with URLs, process it
            if (currentChannel.name && urlLines.length > 0) {
              processChannelUrls(currentChannel, urlLines, channels);
            }
            
            // Parse new channel
            const info = line.substring(8);
            const nameMatch = info.match(/,(.*)/);
            const logoMatch = info.match(/tvg-logo="([^"]*)"/);
            
            currentChannel = {
              name: nameMatch ? nameMatch[1].trim() : 'Unknown',
              logo: logoMatch ? logoMatch[1] : 'https://i.postimg.cc/d1hHy4ss/11.png'
            };
            urlLines = [];
            
          } else if (line && !line.startsWith('#')) {
            // This is a URL line
            urlLines.push(line);
            
            // Check if next line is also a URL (no #EXTINF: before it)
            let j = i + 1;
            while (j < lines.length) {
              const nextLine = lines[j].trim();
              if (nextLine.startsWith('#EXTINF:')) {
                break;
              }
              if (nextLine && !nextLine.startsWith('#')) {
                urlLines.push(nextLine);
              }
              j++;
            }
            i = j - 1; // Skip the URLs we just processed
          }
          
          i++;
        }
        
        // Process last channel
        if (currentChannel.name && urlLines.length > 0) {
          processChannelUrls(currentChannel, urlLines, channels);
        }
        
        return channels;
      } catch (error) {
        console.error('Error loading M3U playlist:', error);
        return [];
      }
    }
    
    // Helper function to process channel URLs
    function processChannelUrls(channel, urls, channels) {
      if (urls.length === 1) {
        // Single URL - add as is
        channels.push({
          name: channel.name,
          logo: channel.logo,
          url: urls[0]
        });
      } else {
        // Multiple URLs - add with numbers
        urls.forEach((url, index) => {
          channels.push({
            name: `${channel.name} ${index + 1}`,
            logo: channel.logo,
            url: url
          });
        });
      }
    }
  </script>
  
  <script>
    // Render channels to the DOM with divider and lazy loading
    function renderChannels() {
      const channelList = document.getElementById('channelList');
      
      if (channels.length === 0) {
        channelList.innerHTML = '<div class="loading">No channels available</div>';
        channelItems = [];
        return;
      }
      
      let html = '<div class="playlist-container">';
      
      channels.forEach((channel, index) => {
        for (let i = 1; i < playlistSources.length; i++) {
          if (index === playlistSources[i].startIndex) {
            html += `<div class="playlist-divider"></div>`;
            break;
          }
        }
        
        html += `
          <div class="channel-item" 
               data-url="${channel.url}" 
               data-logo="${channel.logo}"
               data-index="${index}"
               tabindex="-1">
            <img src="${channel.logo}" 
                 onerror="this.src='https://i.postimg.cc/d1hHy4ss/11.png'; this.onerror=null;"
                 class="channel-logo"
                 loading="lazy"
                 onload="this.classList.add('loaded')">
            <div class="channel-name">${channel.name}</div>
          </div>
        `;
      });
      
      html += '</div>';
      
      channelList.innerHTML = html;
      
      // Preload next few channel logos for smoother scrolling
      preloadVisibleChannelLogos();
      
      // Add click event listeners to channels
      const channelItems = document.querySelectorAll('.channel-item');
      channelItems.forEach((item, index) => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          currentFocusIndex = index;
          setFocus(currentFocusIndex);
          const url = this.getAttribute('data-url');
          const logo = this.getAttribute('data-logo');
          playChannel(url, logo);
          triggerSwitchAd();
          focusOnPlayer();
        });
      });
      
      // Update navigation items
      updateChannelItems();
      switchToChannelsMode();
      
      setTimeout(() => {
        channelList.scrollTop = 0;
      }, 100);
    }
    
    // Preload logos for visible channels
    function preloadVisibleChannelLogos() {
      const images = document.querySelectorAll('.channel-item img');
      const imageArray = Array.from(images);
      
      // Load first 20 images
      imageArray.slice(0, 20).forEach(img => {
        if (!channelLogoCache.has(img.src)) {
          const preloadImg = new Image();
          preloadImg.src = img.src;
          channelLogoCache.set(img.src, true);
        }
      });
    }
  </script>
  
<script>
  // Initialize player with improved loading
  function initPlayer(url, logo) {
    // Show loading overlay
    const loadingOverlay = document.getElementById('videoLoadingOverlay');
    if (loadingOverlay) {
      loadingOverlay.classList.remove('hidden');
    }
    
    // Clear any existing timeout
    if (videoLoadingTimeout) {
      clearTimeout(videoLoadingTimeout);
    }
    
    // Hide loading overlay after 3 seconds max
    videoLoadingTimeout = setTimeout(() => {
      if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
      }
    }, 3000);
    
    // Inject watermark styles
    function injectWatermarkStyles() {
      const style = document.createElement('style');
      style.textContent = `
        .clappr-watermark[data-watermark] {
          position: absolute;
          min-width: 70px;
          max-width: 200px;
          width: 12%;
          text-align: center;
          z-index: 10;
          left: 10% !important;
          bottom: 13% !important;
          top: auto !important;
          right: auto !important;
          transform: scale(0.7) !important;
          transform-origin: left bottom !important;
        }
        
        .clappr-watermark[data-watermark] img {
          max-width: 100%;
          border: none;
          box-shadow: none;
        }
        
        /* Hide poster when video starts playing */
        .clappr-poster.hide {
          opacity: 0;
          transition: opacity 0.5s ease;
        }
      `;
      document.head.appendChild(style);
    }
    
    // Inject watermark styles
    injectWatermarkStyles();
    
    // Preload poster image
    const posterImg = new Image();
    posterImg.src = "https://i.pinimg.com/originals/5a/93/4e/5a934e84f67d2a61a118ec95b1d6cb74.gif";
    
    player = new Clappr.Player({
      source: url,
      parentId: "#player",
      autoPlay: true,
      mute: false,
      width: "100%",
      height: "100%",
      watermark: "https://i.postimg.cc/d1hHy4ss/11.png",
      watermarkPosition: 'bottom-right',
      watermarkOpacity: 0.7,
      plugins: [
        HlsjsPlayback, 
        LevelSelector,
        window.ClapprPipMode ? window.ClapprPipMode.PipButton : null,
        FullscreenLogoPlugin
      ].filter(Boolean),
      mediacontrol: { 
        seekbar: "red", 
        buttons: "white" 
      },
      poster: "https://i.pinimg.com/originals/5a/93/4e/5a934e84f67d2a61a118ec95b1d6cb74.gif"
    });
    
    // Store player globally
    window.player = player;
    
    // Add event listener for when video starts playing
    player.on('play', function() {
      // Hide loading overlay
      if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
      }
      if (videoLoadingTimeout) {
        clearTimeout(videoLoadingTimeout);
      }
      
      // Hide poster
      const posterElement = document.querySelector('.clappr-poster');
      if (posterElement) {
        posterElement.classList.add('hide');
        setTimeout(() => {
          posterElement.style.display = 'none';
        }, 500);
      }
    });
    
    // Add event listener for buffering
    player.on('buffering', function() {
      if (loadingOverlay) {
        loadingOverlay.classList.remove('hidden');
      }
    });
    
    // Add event listener for when buffer is full
    player.on('bufferfull', function() {
      if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
      }
    });
    
    // Add event listener for errors
    player.on('error', function() {
      if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
      }
    });
    
    // Add event listener for when player is ready
    player.on(Clappr.Events.PLAYER_READY, function() {
      // Apply additional watermark styles
      setTimeout(() => {
        const watermark = document.querySelector('.clappr-watermark[data-watermark]');
        if (watermark) {
          watermark.style.left = '10%';
          watermark.style.bottom = '13%';
          watermark.style.top = 'auto';
          watermark.style.right = 'auto';
          watermark.style.transform = 'scale(0.7)';
          watermark.style.transformOrigin = 'left bottom';
          watermark.style.minWidth = '70px';
          watermark.style.maxWidth = '200px';
          watermark.style.width = '12%';
          watermark.style.textAlign = 'center';
          watermark.style.zIndex = '10';
        }
        
        // Apply styles to watermark image
        const watermarkImg = document.querySelector('.clappr-watermark[data-watermark] img');
        if (watermarkImg) {
          watermarkImg.style.maxWidth = '100%';
          watermarkImg.style.border = 'none';
          watermarkImg.style.boxShadow = 'none';
        }
      }, 500);
    });
    
    // Hide fullscreen logo initially
    const logoElement = document.getElementById('fullscreen-logo');
    if (logoElement) {
      logoElement.style.display = 'none';
      logoElement.style.opacity = '0';
    }
  }
</script>
  
  <script>
    // Play a channel with smooth transition
    function playChannel(url, logo) {
      // Show loading overlay
      const loadingOverlay = document.getElementById('videoLoadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.classList.remove('hidden');
      }
      
      // Clear any existing timeout
      if (videoLoadingTimeout) {
        clearTimeout(videoLoadingTimeout);
      }
      
      // Hide loading overlay after 3 seconds max
      videoLoadingTimeout = setTimeout(() => {
        if (loadingOverlay) {
          loadingOverlay.classList.add('hidden');
        }
      }, 3000);
      
      if (player) {
        player.load(url);
        player.configure({ 
          autoPlay: true,
          poster: "https://i.pinimg.com/originals/5a/93/4e/5a934e84f67d2a61a118ec95b1d6cb74.gif"
        });
        
        // Ensure poster is visible
        setTimeout(() => {
          const posterElement = document.querySelector('.clappr-poster');
          if (posterElement) {
            posterElement.style.display = 'block';
            posterElement.classList.remove('hide');
          }
        }, 100);
      } else {
        initPlayer(url, logo);
      }
    }
  </script>
</body>
</html>
