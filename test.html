<!DOCTYPE html>
<html lang="en">
<head>  
  <meta charset="UTF-8">
  <title>Sirome TV</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="author" content="Sirome Live Sports">
  <meta name="referrer" content="no-referrer">
  <meta property="og:image" content="https://i.postimg.cc/d1hHy4ss/11.png">
  
  <!-- Favicon -->
  <link rel="icon" href="https://i.postimg.cc/d1hHy4ss/11.png" type="image/png">
  
  <!-- New Monetag SDK -->
  <script src='//libtl.com/sdk.js' data-zone='9978881' data-sdk='show_9978881'></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  
  <!-- Clappr Core Player and Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/level-selector@0.2.0/dist/level-selector.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@clappr/hlsjs-playback@1.0.1/dist/hlsjs-playback.min.js"></script>
  <!-- PIP Mode Plugin for Clappr (fixed version) -->
  <script src="https://cdn.jsdelivr.net/npm/clappr-pip-mode@1.1.0/dist/clappr-pip-mode.min.js"></script>
  
  <style>
    /* ===== RESET & BASE STYLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
    }
    
    body, html {
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background: #0f0f0f;
      color: #fff;
    }
    
    /* ===== MAIN CONTAINER ===== */
    .main-container {
      display: flex;
      flex-direction: row;
      height: 100vh;
      width: 100vw;
    }
    
    /* ===== PLAYER SECTION ===== */
    .video-container {
      flex: 0 0 70%;
      background: black;
      display: flex;
      flex-direction: column;
      padding: 2px;
    }
    
    .video-wrapper {
      width: 100%;
      flex: 1;
      position: relative;
      background: black;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2px;
    }
    
    #player {
      width: 100%;
      max-width: 1280px;
      aspect-ratio: 16/9;
      border: none;
      display: block;
      margin: 0 auto;
      position: relative;
      outline: none;
    }
    
    /* Fullscreen Logo */
    #fullscreen-logo {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 60px;
      height: auto;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      display: none;
    }
    
    /* ===== CHANNEL SECTION ===== */
    .channel-box {
      flex: 0 0 30%;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
    }
    
    .channel-list {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 1rem;
      padding-bottom: 30px;
    }
    
    .channel-list::-webkit-scrollbar {
      width: 10px;
    }
    
    .channel-list::-webkit-scrollbar-thumb {
      background: red;
      border-radius: 5px;
    }
    
    /* ===== SEARCH BOX ===== */
    .search-container {
      background: #2a2a2a;
      border: 1px solid white;
      border-radius: 3px;
      margin: 0 2%;
      font-size: 10px;
    }
    
    .search-box {
      width: 100%;
      padding: 5px 15px;
      border-radius: 5px;
      border: none;
      background: black;
      color: white;
      font-size: 10px;
      outline: none;
    }
    
    .search-box:focus {
      border-color: white;
    }
    
    .search-box::placeholder {
      color: #888;
    }
    
    .search-results-info {
      text-align: center;
      padding: 5px;
      font-size: 12px;
      color: #aaa;
      background: #2a2a2a;
      border-bottom: 1px solid #444;
    }
    
    .clear-search {
      position: absolute;
      right: 25px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 16px;
      padding: 5px;
    }
    
    /* ===== CHANNEL ITEMS ===== */
    .channel-item {
      background: #333;
      border-radius: 5px;
      text-align: center;
      box-shadow: 0 0 100px rgba(0, 0, 0, 0.4);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      outline: none;
      border: 2px solid transparent;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .channel-item:hover {
      border: 1px solid white;
      box-shadow: 0 0 2px white, 0 0 3px white;
      background: red;
    }
    
    .channel-item.channel-selected {
      border: 1px solid white;
      box-shadow: 0 0 2px white, 0 0 6px white;
      background: black;
    }
    
    .channel-item img {
      width: 100%;
      height: 70px;
      object-fit: contain;
      margin-bottom: 2px;
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
    }
    
    .channel-name {
      margin: 0;
      font-size: 10px !important;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 100%;
      text-align: center;
      color: #fff;
      user-select: none;
    }
    
    /* ===== LOADER ===== */
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid #FFF;
      border-bottom-color: red;
      border-radius: 50%;
      display: block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading {
      text-align: center;
      padding: 2px;
      color: #aaa;
    }
    
    /* ===== COUNTERS ===== */
    #counters {
      text-align: center;
      background-color: #4f4e4e;
      border: 1px solid white;
      border-radius: 3px;
      margin: 1px 2%;
      font-size: 10px;
    }
    
    #counters div {
      margin: 1px 0;
    }
    
    /* ===== PLAYLIST ===== */
    .playlist-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(30%, 1fr));
      gap: 1rem;
      min-height: 100%;
    }
    
    .playlist-divider {
      height: 8px;
      background: linear-gradient(90deg, transparent, #555, transparent);
      margin: 0.5rem 0;
      width: 100%;
      grid-column: 1 / -1;
    }
    
    /* ===== DESKTOP STYLES ===== */
    @media (min-width: 1024px) {
      .channel-item:hover {
        border: 1px solid white;
        box-shadow: 0 0 2px white, 0 0 6px white;
        background: red;
      }
      
      .channel-list::-webkit-scrollbar {
        width: 12px;
      }
      
      #player {
        max-width: 1280px;
      }
      
      #fullscreen-logo {
        width: 60px;
      }
    }
    
    /* ===== MOBILE STYLES ===== */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }
      
      .video-container {
        flex: 0 0 40%;
        padding: 2px;
      }
      
      .channel-box {
        flex: 0 0 60%;
        overflow: hidden;
      }
      
      .playlist-container {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        padding: 0.5rem;
      }
      
      .channel-item {
        padding: 2%;
      }
      
      .channel-item img {
        width: 100%;
        height: 70px;
        object-fit: contain;
      }
      
      .channel-name {
        font-size: 8px !important;
      }
      
      #player {
        aspect-ratio: 16/9;
        max-width: 100%;
      }
      
      .video-wrapper {
        padding: 2px;
      }
      
      #fullscreen-logo {
        width: 40px !important;
        top: 10px !important;
        right: 10px !important;
      }
      
      #counters {
        font-size: 8px;
        margin: 2px 1%;
      }
      
      .search-container {
        margin: 0 1%;
      }
      
      .search-box {
        font-size: 8px;
        padding: 3px 10px;
      }
      
      .channel-list {
        padding: 0.5rem;
      }
    }
    
    /* ===== MOBILE ORIENTATION ===== */
    @media (max-width: 768px) and (orientation: portrait) {
      .video-container { flex: 0 0 40%; }
      .channel-box { flex: 0 0 60%; }
    }
    
    @media (max-width: 768px) and (orientation: landscape) {
      .video-container { flex: 0 0 50%; }
      .channel-box { flex: 0 0 50%; }
    }
    
    /* ===== SMALL MOBILE ===== */
    @media (max-width: 480px) {
      .playlist-container {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.3rem;
        padding: 0.3rem;
      }
      
      .channel-item {
        padding: 3%;
      }
      
      .channel-name {
        font-size: 7px !important;
      }
      
      .channel-item img {
        width: 100%;
        height: 70px;
      }
    }
  </style>
</head>

<body>
  <div class="main-container">
    <!-- Player Section -->
    <div class="video-container">
      <div class="video-wrapper">
        <div id="player" tabindex="-1"></div>
        <img id="fullscreen-logo" src="https://i.postimg.cc/d1hHy4ss/11.png" alt="Sirome TV Logo">
      </div>
      
      <!-- Firebase Counters -->
      <div id="counters">
        <div id="online-counter">Online Now: 0 | Today: 0 | Total: 0</div>
      </div>
      
      <!-- Search Box -->
      <div class="search-container">
        <div style="position: relative;">
          <input type="text" id="channelSearch" class="search-box" placeholder="Search Channels...">
          <button class="clear-search" id="clearSearch" style="display: none;">âœ•</button>
        </div>
      </div>
      
      <div class="search-results-info" id="searchResultsInfo" style="display: none;"></div>
    </div>
    
    <!-- Channel Box -->
    <div class="channel-box">
      <div class="channel-list" id="channelList">
        <span class="loader"></span>
        <div class="loading">Loading Channels...Please wait</div>
      </div>
    </div>
  </div>
  
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBL6nN2TH4uyp8iso6Q99_QHkYyHnslXjU",
      authDomain: "tg-bot-sirome-tv.firebaseapp.com",
      databaseURL: "https://tg-bot-sirome-tv-default-rtdb.firebaseio.com",
      projectId: "tg-bot-sirome-tv",
      storageBucket: "tg-bot-sirome-tv.firebasestorage.app",
      messagingSenderId: "764854962010",
      appId: "1:764854962010:web:6a77f650622614de4d5563"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Playlist URLs
    const m3u1Url = 'https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u';
    const m3u2Url = 'https://raw.githubusercontent.com/sirometv/playlist/main/sirometvsports.m3u';
    
    // ===== GLOBAL VARIABLES =====
    let player;
    let channels = [];
    let playlistSources = [];
    let filteredChannels = [];
    let currentFocusIndex = 0;
    let channelItems = [];
    let isSearchActive = false;
    let lastEnterPressTime = 0;
    let isInFullscreen = false;
    let currentMode = 'channels';
    let focusDebounceTimer = null;
    
    // ===== DISABLE CONTEXT MENU & KEYS =====
    document.addEventListener('contextmenu', (e) => e.preventDefault());
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || 
          (e.ctrlKey && e.shiftKey && e.key === 'J') || (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
      }
    });
    document.addEventListener('dragstart', (e) => e.target.tagName === 'IMG' && e.preventDefault());
    document.addEventListener('selectstart', (e) => e.preventDefault());
    
    // ===== FIREBASE ONLINE COUNTER =====
    const usersRef = db.ref("onlineUsers");
    const totalRef = db.ref("totalVisitors");
    const todayRef = db.ref("dailyVisitors/" + new Date().toISOString().slice(0, 10));
    const sessionId = "user_" + Math.random().toString(36).substring(2, 12);
    
    usersRef.child(sessionId).set({ lastSeen: Date.now() });
    totalRef.transaction(c => (c || 0) + 1);
    todayRef.transaction(c => (c || 0) + 1);
    
    window.addEventListener("beforeunload", () => usersRef.child(sessionId).remove());
    
    const onlineCounter = document.getElementById("online-counter");
    const ACTIVE_THRESHOLD = 5 * 1000;
    
    function updateOnlineCounter() {
      usersRef.once("value").then(snap => {
        const onlineUsers = snap.val() || {};
        const now = Date.now();
        const activeUsers = Object.values(onlineUsers).filter(u => (now - u.lastSeen) <= ACTIVE_THRESHOLD);
        const totalOnline = activeUsers.length;
        totalRef.once("value").then(snap2 => {
          const totalVisitors = snap2.val() || 0;
          todayRef.once("value").then(snap3 => {
            const todayVisitors = snap3.val() || 0;
            onlineCounter.innerHTML = `ðŸ‘¥ Online: ${totalOnline} | ðŸ“… Today: ${todayVisitors} | ðŸŒ Total: ${totalVisitors}`;
          });
        });
      });
    }
    
    updateOnlineCounter();
    usersRef.on("value", updateOnlineCounter);
    setInterval(() => usersRef.child(sessionId).update({ lastSeen: Date.now() }), 15000);
    
    // ===== ADS HANDLER =====
    let lastAdTime = 0;
    function triggerSwitchAd() {
      const now = Date.now();
      if (now - lastAdTime < 120000) return;
      lastAdTime = now;
      if (typeof show_9978881 === 'function') show_9978881();
    }
    
    // ===== FULLSCREEN LOGO PLUGIN =====
    const FullscreenLogoPlugin = Clappr.CorePlugin.extend({
      name: 'fullscreen_logo',
      bindEvents: function() {
        this.listenTo(this.core, Clappr.Events.CORE_FULLSCREEN, this.onFullscreenChange);
      },
      onFullscreenChange: function(isFullscreen) {
        isInFullscreen = isFullscreen;
        const logoElement = document.getElementById('fullscreen-logo');
        if (logoElement) {
          if (isFullscreen) {
            logoElement.style.display = 'block';
            setTimeout(() => logoElement.style.opacity = '0.8', 10);
          } else {
            logoElement.style.opacity = '0';
            setTimeout(() => logoElement.style.display = 'none', 300);
            setTimeout(() => currentMode === 'channels' ? focusOnChannels() : focusOnPlayer(), 100);
          }
        }
      }
    });
    
    // ===== NAVIGATION FUNCTIONS =====
    function updateChannelItems() {
      channelItems = document.querySelectorAll('.channel-item');
      if (channelItems.length > 0) setFocus(currentFocusIndex);
    }
    
    function setFocus(index) {
      if (focusDebounceTimer) clearTimeout(focusDebounceTimer);
      focusDebounceTimer = setTimeout(() => {
        channelItems.forEach(item => {
          item.classList.remove('channel-selected');
          item.setAttribute('tabindex', '-1');
        });
        
        if (channelItems.length > 0 && index >= 0 && index < channelItems.length) {
          currentFocusIndex = index;
          const selectedItem = channelItems[currentFocusIndex];
          selectedItem.classList.add('channel-selected');
          selectedItem.setAttribute('tabindex', '0');
          requestAnimationFrame(() => {
            selectedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
          });
        }
      }, 50);
    }
    
    function getGridColumns() {
      const container = document.querySelector('.playlist-container');
      if (!container) return 3;
      return Math.max(window.getComputedStyle(container).gridTemplateColumns.split(' ').length, 3);
    }
    
    function navigateUp() {
      if (channelItems.length === 0 || currentMode !== 'channels') return;
      const cols = getGridColumns();
      if (currentFocusIndex >= cols) {
        setFocus(currentFocusIndex - cols);
      } else {
        const rows = Math.ceil(channelItems.length / cols);
        setFocus(Math.min((rows - 1) * cols + (currentFocusIndex % cols), channelItems.length - 1));
      }
    }
    
    function navigateDown() {
      if (channelItems.length === 0 || currentMode !== 'channels') return;
      const cols = getGridColumns();
      if (currentFocusIndex + cols < channelItems.length) {
        setFocus(currentFocusIndex + cols);
      } else {
        setFocus(currentFocusIndex % cols);
      }
    }
    
    function navigateLeft() {
      if (channelItems.length === 0 || currentMode !== 'channels') return;
      setFocus(currentFocusIndex > 0 ? currentFocusIndex - 1 : channelItems.length - 1);
    }
    
    function navigateRight() {
      if (channelItems.length === 0 || currentMode !== 'channels') return;
      setFocus(currentFocusIndex < channelItems.length - 1 ? currentFocusIndex + 1 : 0);
    }
    
    function selectChannel() {
      if (channelItems.length > 0 && currentFocusIndex < channelItems.length) {
        const item = channelItems[currentFocusIndex];
        playChannel(item.getAttribute('data-url'), item.getAttribute('data-logo'));
        triggerSwitchAd();
      }
    }
    
    function toggleFullscreen() {
      if (player && player.core) player.core.toggleFullscreen();
    }
    
    function togglePlayPause() {
      if (player) player.isPlaying() ? player.pause() : player.play();
    }
    
    function focusOnPlayer() {
      currentMode = 'player';
      document.getElementById('player').focus();
      channelItems.forEach(item => {
        item.classList.remove('channel-selected');
        item.setAttribute('tabindex', '-1');
      });
    }
    
    function focusOnChannels() {
      currentMode = 'channels';
      if (channelItems.length > 0) setFocus(currentFocusIndex);
    }
    
    function handleEnterPress() {
      const now = Date.now();
      if (isInFullscreen) {
        if (now - lastEnterPressTime < 1000) togglePlayPause();
        else if (player && player.core) player.core.toggleFullscreen();
      } else {
        if (now - lastEnterPressTime < 1000) toggleFullscreen();
        else selectChannel();
      }
      lastEnterPressTime = now;
    }
    
    function handleTVRemoteKey(e) {
      const key = e.key;
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter', ' ', 'Escape', 'Tab', 'Backspace', 'f', 'F'].includes(key)) {
        e.preventDefault();
      }
      
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
        if (currentMode === 'channels') {
          if (key === 'ArrowUp') navigateUp();
          else if (key === 'ArrowDown') navigateDown();
          else if (key === 'ArrowLeft') navigateLeft();
          else if (key === 'ArrowRight') navigateRight();
        } else if (currentMode === 'player' && !isInFullscreen) {
          focusOnChannels();
        }
      } else {
        if (key === 'Enter' || key === ' ') handleEnterPress();
        else if (key === 'f' || key === 'F') toggleFullscreen();
        else if (key === 'Escape' || key === 'Backspace') {
          if (isInFullscreen) toggleFullscreen();
          else if (currentMode === 'player') focusOnChannels();
        } else if (key === 'Tab') {
          currentMode === 'channels' ? focusOnPlayer() : focusOnChannels();
        }
      }
    }
    
    // ===== SEARCH FUNCTIONS =====
    function setupSearch() {
      const searchInput = document.getElementById('channelSearch');
      const clearButton = document.getElementById('clearSearch');
      const searchResultsInfo = document.getElementById('searchResultsInfo');
      
      searchInput.addEventListener('input', function() {
        const term = this.value.trim().toLowerCase();
        if (term.length > 0) {
          isSearchActive = true;
          clearButton.style.display = 'block';
          filteredChannels = channels.filter(c => c.name.toLowerCase().includes(term));
          renderFilteredChannels();
          searchResultsInfo.textContent = filteredChannels.length ? 
            `Found ${filteredChannels.length} channel(s) for "${term}"` : 
            `No channels found for "${term}"`;
          searchResultsInfo.style.display = 'block';
        } else {
          isSearchActive = false;
          clearButton.style.display = 'none';
          searchResultsInfo.style.display = 'none';
          renderChannels();
        }
      });
      
      clearButton.addEventListener('click', () => {
        searchInput.value = '';
        isSearchActive = false;
        clearButton.style.display = 'none';
        searchResultsInfo.style.display = 'none';
        renderChannels();
        focusOnChannels();
      });
      
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          e.preventDefault();
          searchInput.focus();
        } else if (e.key === '/' && document.activeElement !== searchInput) {
          e.preventDefault();
          searchInput.focus();
        }
      });
    }
    
    // ===== LOAD CHANNELS (UPDATED WITH MULTIPLE URL SUPPORT) =====
    async function loadChannels() {
      try {
        channels = [];
        playlistSources = [];
        let startIndex = 0;
        
        const playlists = [
          { url: m3u1Url, name: "SiromeTV" },
          { url: m3u2Url, name: "Sports" }
        ];
        
        for (let i = 0; i < playlists.length; i++) {
          const m3uChannels = await loadM3uPlaylist(playlists[i].url);
          if (m3uChannels && m3uChannels.length > 0) {
            playlistSources.push({ name: playlists[i].name, startIndex, count: m3uChannels.length });
            channels = channels.concat(m3uChannels);
            startIndex += m3uChannels.length;
          }
        }
        
        renderChannels();
        if (channels.length > 0) initPlayer(channels[0].url, channels[0].logo);
      } catch (error) {
        document.getElementById('channelList').innerHTML = '<div class="loading">Error loading channels</div>';
      }
    }
    
    // ===== LOAD M3U (UPDATED WITH MULTIPLE URL SUPPORT) =====
    async function loadM3uPlaylist(url) {
      try {
        const response = await fetch(url);
        const text = await response.text();
        const channels = [];
        const lines = text.split('\n');
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          
          if (line.startsWith('#EXTINF:')) {
            const info = line.substring(8);
            const nameMatch = info.match(/,(.*)/);
            const logoMatch = info.match(/tvg-logo="([^"]*)"/);
            
            let channelName = nameMatch ? nameMatch[1].trim() : 'Unknown';
            let channelLogo = logoMatch ? logoMatch[1] : 'https://i.postimg.cc/d1hHy4ss/11.png';
            
            // Collect all URLs until next #EXTINF:
            let urls = [];
            let j = i + 1;
            while (j < lines.length) {
              const nextLine = lines[j].trim();
              if (nextLine.startsWith('#EXTINF:')) {
                break;
              }
              if (nextLine && !nextLine.startsWith('#')) {
                urls.push(nextLine);
              }
              j++;
            }
            
            // If multiple URLs found, create separate channels with numbers
            if (urls.length > 1) {
              urls.forEach((url, index) => {
                channels.push({
                  name: `${channelName} ${index + 1}`,
                  logo: channelLogo,
                  url: url
                });
              });
            } else if (urls.length === 1) {
              channels.push({
                name: channelName,
                logo: channelLogo,
                url: urls[0]
              });
            }
            
            i = j - 1; // Skip processed URLs
          }
        }
        return channels;
      } catch (error) {
        return [];
      }
    }
    
    // ===== RENDER FUNCTIONS =====
    function renderChannels() {
      const channelList = document.getElementById('channelList');
      if (channels.length === 0) {
        channelList.innerHTML = '<div class="loading">No channels available</div>';
        channelItems = [];
        return;
      }
      
      let html = '<div class="playlist-container">';
      channels.forEach((channel, index) => {
        for (let i = 1; i < playlistSources.length; i++) {
          if (index === playlistSources[i].startIndex) {
            html += '<div class="playlist-divider"></div>';
            break;
          }
        }
        
        html += `
          <div class="channel-item" data-url="${channel.url}" data-logo="${channel.logo}" data-index="${index}" tabindex="-1">
            <img src="${channel.logo}" onerror="this.src='https://i.postimg.cc/d1hHy4ss/11.png';" class="channel-logo">
            <div class="channel-name">${channel.name}</div>
          </div>
        `;
      });
      html += '</div>';
      
      channelList.innerHTML = html;
      attachChannelEvents();
    }
    
    function renderFilteredChannels() {
      const channelList = document.getElementById('channelList');
      if (filteredChannels.length === 0) {
        channelList.innerHTML = '<div class="loading">No channels found</div>';
        channelItems = [];
        return;
      }
      
      let html = '<div class="playlist-container">';
      filteredChannels.forEach((channel, index) => {
        html += `
          <div class="channel-item" data-url="${channel.url}" data-logo="${channel.logo}" data-index="${index}" tabindex="-1">
            <img src="${channel.logo}" onerror="this.src='https://i.postimg.cc/d1hHy4ss/11.png';" class="channel-logo">
            <div class="channel-name">${channel.name}</div>
          </div>
        `;
      });
      html += '</div>';
      
      channelList.innerHTML = html;
      attachChannelEvents();
    }
    
    function attachChannelEvents() {
      document.querySelectorAll('.channel-item').forEach((item, index) => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          currentFocusIndex = index;
          setFocus(currentFocusIndex);
          playChannel(item.getAttribute('data-url'), item.getAttribute('data-logo'));
          triggerSwitchAd();
          focusOnPlayer();
        });
      });
      
      updateChannelItems();
      focusOnChannels();
      setTimeout(() => document.getElementById('channelList').scrollTop = 0, 100);
    }
    
    // ===== INIT PLAYER (with PIP fix) =====
    function initPlayer(url, logo) {
      // PIP plugin correctly configured
      const pipPlugin = window.ClapprPipMode ? 
        (typeof window.ClapprPipMode.PipButton === 'function' ? window.ClapprPipMode.PipButton : window.ClapprPipMode) : null;
      
      player = new Clappr.Player({
        source: url,
        parentId: "#player",
        autoPlay: true,
        mute: false,
        width: "100%",
        height: "100%",
        plugins: [HlsjsPlayback, LevelSelector, pipPlugin, FullscreenLogoPlugin].filter(Boolean),
        mediacontrol: { 
          seekbar: "#0a60f5", 
          buttons: "white"
        },
        poster: "https://i.pinimg.com/originals/5a/93/4e/5a934e84f67d2a61a118ec95b1d6cb74.gif"
      });
      
      window.player = player;
      
      player.on('play', () => {
        const poster = document.querySelector('.poster');
        if (poster) {
          poster.style.opacity = '0';
          setTimeout(() => poster.style.display = 'none', 1000);
        }
      });
      
      document.getElementById('fullscreen-logo').style.display = 'none';
    }
    
    function playChannel(url, logo) {
      if (player) {
        player.load(url);
        player.configure({ autoPlay: true });
      } else {
        initPlayer(url, logo);
      }
    }
    
    // ===== INITIALIZE =====
    document.addEventListener('DOMContentLoaded', () => {
      loadChannels();
      setupSearch();
      document.addEventListener('keydown', handleTVRemoteKey);
      focusOnChannels();
      
      document.addEventListener('click', (e) => {
        if (e.target.closest('.channel-item')) {
          const index = Array.from(channelItems).indexOf(e.target.closest('.channel-item'));
          if (index >= 0) {
            currentFocusIndex = index;
            setFocus(currentFocusIndex);
          }
        } else if (e.target.closest('#player') || e.target.closest('.video-wrapper')) {
          focusOnPlayer();
        }
      });
      
      setTimeout(() => {
        document.getElementById('channelList').scrollTop = 0;
        focusOnChannels();
      }, 1500);
    });
  </script>
</body>
</html>
