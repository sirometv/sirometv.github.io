<!DOCTYPE html>
<html lang="en">
<head>  
  <meta charset="UTF-8">
  <title>Sirome TV</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="author" content="Sirome Live Sports">
  <meta name="referrer" content="no-referrer">
  <meta property="og:image" content="https://i.postimg.cc/d1hHy4ss/11.png">

  <!-- Preconnect for critical domains -->
  <link rel="preconnect" href="https://i.postimg.cc">
  <link rel="preconnect" href="https://raw.githubusercontent.com">
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">

  <!-- Preload critical resources -->
  <link rel="preload" href="https://i.postimg.cc/d1hHy4ss/11.png" as="image">
  
  <!-- Favicon -->
  <link rel="icon" href="https://i.postimg.cc/d1hHy4ss/11.png" type="image/png">

  <!-- New Monetag SDK -->
  <script src='//libtl.com/sdk.js' data-zone='9978881' data-sdk='show_9978881' async></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js" defer></script>

  <!-- Clappr Core Player and Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/level-selector@0.2.0/dist/level-selector.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@clappr/hlsjs-playback@1.0.1/dist/hlsjs-playback.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/clappr-pip-mode@1.1.0/dist/clappr-pip-mode.min.js" defer></script>

  <style>
    /* CSS Reset with performance optimizations */
    * { 
      margin:0; 
      padding:0; 
      box-sizing:border-box; 
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
    }
    
    body, html { 
      height:100%; 
      overflow:hidden; 
      font-family:sans-serif; 
      background:#0f0f0f; 
      color:#fff; 
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }
    
    /* Disable text selection and image drag */
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
    }

    .main-container {
      display:flex;
      flex-direction:row;
      height:100vh;
      width:100vw;
      contain: strict;
    }

    /* Player */
    .video-container {
      flex:0 0 70%;
      background: black;
      display:flex;
      flex-direction: column;
      padding: 10px;
      contain: strict;
    }
    
    .video-wrapper {
      width:100%;
      flex:1;
      position:relative;
      background:black;
      overflow:hidden;
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 5px;
      contain: strict;
    }
   
    #player {
      width: 100%;
      max-width: 1280px;
      aspect-ratio: 16/9;
      border: none;
      display: block;
      margin: 0 auto;
      box-shadow: none;
      position: relative;
      outline: none;
      contain: strict;
      transform: translateZ(0);
      backface-visibility: hidden;
      perspective: 1000;
    }
    
    /* Fullscreen Logo */
    #fullscreen-logo {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 60px;
      height: auto;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      display: none;
      transition: opacity 0.3s ease-in-out;
      will-change: opacity;
    }
    
    .video-watermark {
      position:absolute; 
      top:10px; 
      left:10px; 
      width:50px; 
      opacity:.7; 
      z-index:10;
    }

    /* Channel box */
    .channel-box {
      flex:0 0 30%;
      background:#1a1a1a;
      display:flex;
      flex-direction:column;
      height:100%;
      position:relative;
      contain: strict;
    }

    /* Channel list scroll area */
    .channel-list {
      flex:1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 1rem;
      padding-bottom: 30px;
      -webkit-overflow-scrolling: touch;
      contain: strict;
      will-change: transform;
    }

    .channel-list::-webkit-scrollbar { 
      width: 8px; 
    }
    
    .channel-list::-webkit-scrollbar-thumb { 
      background: red; 
      border-radius: 4px; 
    }

    /* Search Box Styles */
    .search-container {
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 3px;
      margin-left:2%;
      margin-right:2%;
      font-size: 10px;
      padding: 0;
      contain: strict;
    }

    .search-box {
      width: 100%;
      padding: 5px 15px;
      border-radius: 5px;
      border: none;
      background: black;
      color: white;
      font-size: 10px;
      outline: none;
      transition: all 0.3s ease;
    }

    .search-box:focus {
      border-color: white;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
    }

    .search-box::placeholder {
      color: #888;
    }

    .search-results-info {
      text-align: center;
      padding: 10px;
      font-size: 12px;
      color: #aaa;
      background: #2a2a2a;
      border-bottom: 1px solid #444;
      contain: strict;
    }

    .clear-search {
      position: absolute;
      right: 25px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 16px;
      padding: 5px;
    }

    .clear-search:hover {
      color: red;
    }

    /* Channel item styles - PERFORMANCE OPTIMIZED */
    .playlist-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(30%, 1fr));
      gap: 1rem;
      min-height: 100%;
      contain: strict;
    }
    
    .channel-item {
      background: #333;
      border-radius: 5px;
      text-align: center;
      padding: 2%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      outline: none;
      border: 2px solid transparent;
      user-select: none;
      contain: strict;
      transform: translateZ(0);
      backface-visibility: hidden;
      will-change: transform;
      transition: all 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* Removed animations that cause blinking */
    /* transform: scale(0.98); REMOVED */
    /* animation: fadeInUp 2s ease both; REMOVED */

    .channel-item:hover {
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 2px rgba(255, 255, 255, 0.5), 0 0 6px rgba(255, 255, 255, 0.3);
      background: #444;
      transform: translateY(-4px) scale(1.02);
    }

    /* Focus state for TV remote navigation */
    .channel-item:focus {
      outline: none;
      border: 1px solid white;
      box-shadow: 0 0 2px white, 0 0 6px rgba(255, 255, 255, 0.5);
      background: #555;
      transform: scale(1.05);
      z-index: 10;
    }

    .channel-item.channel-selected {
      border: 1px solid white;
      box-shadow: 0 0 2px white, 0 0 6px rgba(255, 255, 255, 0.5);
      background: #222;
      transform: scale(1.05);
    }

    /* Optimized image loading */
    .channel-item img {
      width: 100%;
      height: 70px;
      object-fit: contain;
      margin-bottom: 2px;
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
      background: #222;
      opacity: 0;
      transition: opacity 0.3s ease;
      transform: translateZ(0);
    }

    .channel-item img.loaded {
      opacity: 1;
    }

    .channel-item .image-placeholder {
      width: 100%;
      height: 70px;
      background: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 10px;
    }

    .channel-name {
      margin: 0;
      font-size: 10px !important;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 100%;
      text-align: center;
      color: #fff;
      user-select: none;
      padding: 2px 0;
    }
    
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid #FFF;
      border-bottom-color: red;
      border-radius: 50%;
      display: block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Loading indicator */
    .loading {
      text-align: center;
      padding: 20px;
      color: #aaa;
    }
    
    /* Firebase Counter Styles */
    #counters {
      text-align: center;
      background-color: #4f4e4e;
      border:1px solid #666;
      border-radius: 3px;
      margin: 1px 0;
      margin-left:2%;
      margin-right:2%;
      font-size: 10px;
      padding: 5px;
      contain: strict;
    }

    #counters div {
      margin: 1px 0;
    }
    
    .playlist-divider {
      height: 8px;
      background: linear-gradient(90deg, transparent, #555, transparent);
      margin: 0.5rem 0;
      width: 100%;
      grid-column: 1 / -1;
    }
    
    /* PIP Button Custom Styling */
    .pip-button {
      background: rgba(0, 0, 0, 0.7) !important;
      border: 1px solid white !important;
      border-radius: 4px !important;
    }

    .pip-button:hover {
      background: red !important;
    }

    /* Mobile Styles - Optimized */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        contain: strict;
      }
      
      .video-container {
        flex: 0 0 40%;
        padding: 5px;
        contain: strict;
      }
      
      .channel-box {
        flex: 0 0 60%;
        overflow: hidden;
        contain: strict;
      }
      
      .playlist-container {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        padding: 0.5rem;
      }
      
      .channel-item {
        padding: 5%;
      }
      
      .channel-item img {
        width: 100%;
        height: 60px;
        object-fit: contain;
      }
      
      .channel-name {
        font-size: 8px !important;
      }
      
      #player {
        aspect-ratio: 16/9;
        max-width: 100%;
      }
      
      .video-wrapper {
        padding: 2px;
      }
      
      #fullscreen-logo {
        width: 40px !important;
        top: 10px !important;
        right: 10px !important;
      }
      
      .pip-button {
        transform: scale(0.9);
      }
      
      #counters {
        font-size: 8px;
        margin: 2px 0;
        margin-left: 1%;
        margin-right: 1%;
        padding: 3px;
      }
      
      .search-container {
        margin-left: 1%;
        margin-right: 1%;
      }
      
      .search-box {
        font-size: 8px;
        padding: 3px 10px;
      }
      
      .channel-list {
        padding: 0.5rem;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Disable hover effects on mobile */
      .channel-item:hover {
        transform: none;
        border-color: transparent;
        background: #333;
      }
    }

    /* Mobile Portrait Mode */
    @media (max-width: 768px) and (orientation: portrait) {
      .video-container {
        flex: 0 0 40%;
      }
      
      .channel-box {
        flex: 0 0 60%;
      }
    }

    /* Mobile Landscape Mode */
    @media (max-width: 768px) and (orientation: landscape) {
      .video-container {
        flex: 0 0 50%;
      }
      
      .channel-box {
        flex: 0 0 50%;
      }
    }

    /* Small Mobile Devices */
    @media (max-width: 480px) {
      .playlist-container {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.3rem;
        padding: 0.3rem;
      }
      
      .channel-item {
        padding: 3%;
      }
      
      .channel-name {
        font-size: 7px !important;
      }
      
      .channel-item img {
        width: 100%;
        height: 50px;
      }
    }
  </style>
</head>
<body>

<div class="main-container">
  <!-- Player -->
  <div class="video-container">
    <div class="video-wrapper">
      <div id="player" tabindex="-1"></div>
      <!-- Fullscreen Logo (will be controlled by JavaScript) -->
      <img id="fullscreen-logo" src="https://i.postimg.cc/d1hHy4ss/11.png" alt="Sirome TV Logo" loading="lazy">
    </div>
    
    <!-- Firebase Counters -->
    <div id="counters">
      <div id="online-counter">Online Now: 0 | Today: 0 | Total: 0</div>
    </div>

    <!-- Search Box -->
    <div class="search-container">
      <div style="position: relative;">
        <input type="text" id="channelSearch" class="search-box" placeholder="Search Channels...">
        <button class="clear-search" id="clearSearch" style="display: none;">‚úï</button>
      </div>
    </div>

    <!-- Search Results Info -->
    <div class="search-results-info" id="searchResultsInfo" style="display: none;"></div>
  </div>

  <!-- Channel box -->
  <div class="channel-box">
    <!-- Channel list -->
    <div class="channel-list" id="channelList">
      <span class="loader"></span>
      <div class="loading">Loading Channels...Please wait</div>
    </div>
  </div>
</div>

<script>
  // ‡¶ü‡¶ø‡¶≠‡¶ø ‡¶∞‡¶ø‡¶Æ‡ßã‡¶ü ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤
  let currentFocusIndex = 0;
  let channelItems = [];
  let isSearchActive = false;
  let lastEnterPressTime = 0;
  let lastKeyPressTime = 0;
  let isInFullscreen = false;
  let currentMode = 'channels';
  let lastNormalModeTime = 0;
  let isDoubleClickMode = false;
  let focusDebounceTimer = null;
  let imageObserver = null;
  
  // ‡¶∏‡¶ø‡¶ô‡ßç‡¶ó‡ßá‡¶≤‡¶ü‡¶® ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶®‡¶æ‡¶∞
  function initEventListeners() {
    // ‡¶°‡¶ø‡¶∏‡ßá‡¶¨‡¶≤ ‡¶∞‡¶æ‡¶á‡¶ü-‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶®‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶Æ‡ßá‡¶®‡ßÅ
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      return false;
    }, { passive: false });

    // ‡¶°‡¶ø‡¶∏‡ßá‡¶¨‡¶≤ F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
    document.addEventListener('keydown', function(e) {
      if (
        e.key === 'F12' ||
        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
        (e.ctrlKey && e.shiftKey && e.key === 'J') ||
        (e.ctrlKey && e.key === 'U') ||
        (e.metaKey && e.altKey && e.key === 'I') ||
        (e.metaKey && e.altKey && e.key === 'J')
      ) {
        e.preventDefault();
        return false;
      }
    }, { passive: false });

    // ‡¶°‡¶ø‡¶∏‡ßá‡¶¨‡¶≤ ‡¶°‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ó ‡¶è‡¶®‡ßç‡¶° ‡¶°‡ßç‡¶∞‡¶™ ‡¶´‡¶∞ ‡¶á‡¶Æ‡ßá‡¶ú
    document.addEventListener('dragstart', function(e) {
      if (e.target.tagName === 'IMG') {
        e.preventDefault();
        return false;
      }
    }, { passive: false });

    // ‡¶°‡¶ø‡¶∏‡ßá‡¶¨‡¶≤ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶®
    document.addEventListener('selectstart', function(e) {
      e.preventDefault();
      return false;
    }, { passive: false });
  }

  // ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
  const firebaseConfig = {
    apiKey: "AIzaSyBL6nN2TH4uyp8iso6Q99_QHkYyHnslXjU",
    authDomain: "tg-bot-sirome-tv.firebaseapp.com",
    databaseURL: "https://tg-bot-sirome-tv-default-rtdb.firebaseio.com",
    projectId: "tg-bot-sirome-tv",
    storageBucket: "tg-bot-sirome-tv.firebasestorage.app",
    messagingSenderId: "764854962010",
    appId: "1:764854962010:web:6a77f650622614de4d5563",
    measurementId: "G-8G48FV41TH"
  };
  
  // ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú
  let firebaseInitialized = false;
  
  function initializeFirebase() {
    if (typeof firebase !== 'undefined' && !firebaseInitialized) {
      firebase.initializeApp(firebaseConfig);
      window.db = firebase.database();
      firebaseInitialized = true;
    }
  }

  // ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü URLs
  const m3u1Url = 'https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u';
  const m3u2Url = 'https://raw.githubusercontent.com/sirometv/playlist/main/sirometvsports.m3u';
  const m3u3Url = '*/';
  const m3u4Url = '*/';
  const m3u5Url = '*/';
  const m3u6Url = '*/';

  // ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤
  let player;
  let channels = [];
  let playlistSources = [];
  let filteredChannels = [];

  // ‡¶´‡ßÅ‡¶≤‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶≤‡ßã‡¶ó‡ßã ‡¶™‡ßç‡¶≤‡¶æ‡¶ó‡¶ø‡¶®
  const FullscreenLogoPlugin = Clappr.CorePlugin.extend({
    name: 'fullscreen_logo',
    
    bindEvents: function() {
      this.listenTo(this.core, Clappr.Events.CORE_FULLSCREEN, this.onFullscreenChange);
    },
    
    onFullscreenChange: function(isFullscreen) {
      isInFullscreen = isFullscreen;
      const logoElement = document.getElementById('fullscreen-logo');
      if (logoElement) {
        if (isFullscreen) {
          logoElement.style.display = 'block';
          requestAnimationFrame(() => {
            logoElement.style.opacity = '0.8';
          });
        } else {
          logoElement.style.opacity = '0';
          setTimeout(() => {
            logoElement.style.display = 'none';
          }, 300);
          
          // ‡¶´‡ßÅ‡¶≤‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßá‡¶∞ ‡¶π‡¶≤‡ßá ‡¶ï‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßã‡¶°‡ßá ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®
          setTimeout(() => {
            if (currentMode === 'channels') {
              focusOnChannels();
            } else {
              focusOnPlayer();
            }
          }, 100);
        }
      }
    }
  });

  // ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶æ‡¶∞
  let usersRef, totalRef, todayRef;
  const sessionId = "user_" + Math.random().toString(36).substring(2, 12);
  
  function initFirebaseCounters() {
    if (!window.db) return;
    
    usersRef = db.ref("onlineUsers");
    totalRef = db.ref("totalVisitors");
    todayRef = db.ref("dailyVisitors/" + new Date().toISOString().slice(0, 10));
    
    usersRef.child(sessionId).set({
      lastSeen: Date.now()
    });
    
    totalRef.transaction(c => (c || 0) + 1);
    todayRef.transaction(c => (c || 0) + 1);
    
    window.addEventListener("beforeunload", () => {
      if (usersRef) {
        usersRef.child(sessionId).remove();
      }
    });
    
    const onlineCounter = document.getElementById("online-counter");
    const ACTIVE_THRESHOLD = 5 * 1000;

    function updateOnlineCounter() {
      usersRef.once("value").then(snap => {
        const onlineUsers = snap.val() || {};
        const now = Date.now();
        const activeUsers = Object.values(onlineUsers).filter(u => (now - u.lastSeen) <= ACTIVE_THRESHOLD);
        const totalOnline = activeUsers.length;
        totalRef.once("value").then(snap2 => {
          const totalVisitors = snap2.val() || 0;
          todayRef.once("value").then(snap3 => {
            const todayVisitors = snap3.val() || 0;
            if (onlineCounter) {
              onlineCounter.innerHTML = `üë• Online: ${totalOnline} | üìÖ Today: ${todayVisitors} | üåç Total: ${totalVisitors}`;
            }
          });
        });
      });
    }
    
    updateOnlineCounter();
    usersRef.on("value", updateOnlineCounter);
    
    setInterval(() => {
      if (usersRef) {
        usersRef.child(sessionId).update({
          lastSeen: Date.now()
        });
      }
    }, 15000);
  }

  // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶™‡¶ü‡¶ø‡¶Æ‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®
  function initImageLoading() {
    // ‡¶≤‡ßá‡¶á‡¶ú‡¶ø ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶Ö‡¶¨‡¶ú‡¶æ‡¶∞‡¶≠‡¶æ‡¶∞
    if ('IntersectionObserver' in window) {
      imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            const src = img.getAttribute('data-src');
            if (src) {
              img.src = src;
              img.removeAttribute('data-src');
            }
            
            img.onload = function() {
              this.classList.add('loaded');
            };
            
            img.onerror = function() {
              this.src = 'https://i.postimg.cc/d1hHy4ss/11.png';
              this.classList.add('loaded');
            };
            
            imageObserver.unobserve(img);
          }
        });
      }, {
        rootMargin: '50px',
        threshold: 0.1
      });
    }
  }

  function observeImages() {
    if (!imageObserver) return;
    
    const images = document.querySelectorAll('.channel-item img[data-src]');
    images.forEach(img => {
      imageObserver.observe(img);
    });
  }

  // ================================
  // TV REMOTE NAVIGATION FUNCTIONS
  // ================================

  function updateChannelItems() {
    channelItems = document.querySelectorAll('.channel-item');
    if (channelItems.length > 0) {
      setFocus(currentFocusIndex);
    }
    
    // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶Ö‡¶¨‡¶ú‡¶æ‡¶∞‡¶≠ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
    observeImages();
  }

  function setFocus(index) {
    // ‡¶°‡¶ø‡¶¨‡¶æ‡¶â‡¶®‡ßç‡¶∏ ‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶ö‡ßá‡¶û‡ßç‡¶ú
    if (focusDebounceTimer) {
      clearTimeout(focusDebounceTimer);
    }
    
    focusDebounceTimer = setTimeout(() => {
      // ‡¶∏‡¶¨ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
      channelItems.forEach(item => {
        item.classList.remove('channel-selected');
        item.setAttribute('tabindex', '-1');
      });
      
      // ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶®‡¶°‡ßá‡¶ï‡ßç‡¶∏‡ßá ‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
      if (channelItems.length > 0 && index >= 0 && index < channelItems.length) {
        currentFocusIndex = index;
        const selectedItem = channelItems[currentFocusIndex];
        
        selectedItem.classList.add('channel-selected');
        selectedItem.setAttribute('tabindex', '0');
        
        // ‡¶∏‡ßç‡¶Æ‡ßÅ‡¶• ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡ßã‡¶≤ ‡¶á‡¶®‡¶ü‡ßÅ ‡¶≠‡¶ø‡¶â
        requestAnimationFrame(() => {
          selectedItem.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest',
            inline: 'nearest'
          });
        });
      }
    }, 50);
  }

  function navigateUp() {
    if (channelItems.length === 0 || currentMode !== 'channels') return;
    
    const columns = getGridColumns();
    if (currentFocusIndex >= columns) {
      setFocus(currentFocusIndex - columns);
    } else {
      // ‡¶∂‡ßá‡¶∑ ‡¶∏‡¶æ‡¶∞‡¶ø‡¶§‡ßá ‡¶Ø‡¶æ‡¶® ‡¶Ø‡¶¶‡¶ø ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡ßá‡¶®
      const rows = Math.ceil(channelItems.length / columns);
      const lastRowStart = (rows - 1) * columns;
      const targetIndex = Math.min(lastRowStart + (currentFocusIndex % columns), channelItems.length - 1);
      setFocus(targetIndex);
    }
  }

  function navigateDown() {
    if (channelItems.length === 0 || currentMode !== 'channels') return;
    
    const columns = getGridColumns();
    if (currentFocusIndex + columns < channelItems.length) {
      setFocus(currentFocusIndex + columns);
    } else {
      // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶∏‡¶æ‡¶∞‡¶ø‡¶§‡ßá ‡¶Ø‡¶æ‡¶® ‡¶Ø‡¶¶‡¶ø ‡¶®‡ßÄ‡¶ö‡ßá ‡¶•‡¶æ‡¶ï‡ßá‡¶®
      setFocus(currentFocusIndex % columns);
    }
  }

  function navigateLeft() {
    if (channelItems.length === 0 || currentMode !== 'channels') return;
    
    if (currentFocusIndex > 0) {
      setFocus(currentFocusIndex - 1);
    } else {
      // ‡¶∂‡ßá‡¶∑ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá ‡¶Ø‡¶æ‡¶®
      setFocus(channelItems.length - 1);
    }
  }

  function navigateRight() {
    if (channelItems.length === 0 || currentMode !== 'channels') return;
    
    if (currentFocusIndex < channelItems.length - 1) {
      setFocus(currentFocusIndex + 1);
    } else {
      // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá ‡¶Ø‡¶æ‡¶®
      setFocus(0);
    }
  }

  function handleEnterPress() {
    const now = Date.now();
    
    if (isInFullscreen) {
      // ‡¶´‡ßÅ‡¶≤‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶Æ‡ßã‡¶°‡ßá
      if (now - lastEnterPressTime < 1000) {
        // ‡¶´‡ßÅ‡¶≤‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶°‡¶æ‡¶¨‡¶≤ ‡¶™‡ßç‡¶∞‡ßá‡¶∏: ‡¶™‡ßç‡¶≤‡ßá/‡¶™‡¶ú
        togglePlayPause();
      } else {
        // ‡¶´‡ßÅ‡¶≤‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶∏‡¶ø‡¶ô‡ßç‡¶ó‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡ßá‡¶∏: ‡¶®‡¶∞‡¶Æ‡¶æ‡¶≤ ‡¶Æ‡ßã‡¶°‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®
        exitToNormalMode();
      }
    } else {
      // ‡¶®‡¶∞‡¶Æ‡¶æ‡¶≤ ‡¶Æ‡ßã‡¶°‡ßá
      if (now - lastEnterPressTime < 1000) {
        // ‡¶®‡¶∞‡¶Æ‡¶æ‡¶≤ ‡¶Æ‡ßã‡¶°‡ßá ‡¶°‡¶æ‡¶¨‡¶≤ ‡¶™‡ßç‡¶∞‡ßá‡¶∏: ‡¶´‡ßÅ‡¶≤‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶Ø‡¶æ‡¶®
        enterFullscreen();
      } else {
        // ‡¶®‡¶∞‡¶Æ‡¶æ‡¶≤ ‡¶Æ‡ßã‡¶°‡ßá ‡¶∏‡¶ø‡¶ô‡ßç‡¶ó‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡ßá‡¶∏: ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        selectChannel();
      }
    }
    
    lastEnterPressTime = now;
  }

  function selectChannel() {
    if (channelItems.length > 0 && currentFocusIndex < channelItems.length) {
      const selectedItem = channelItems[currentFocusIndex];
      const url = selectedItem.getAttribute('data-url');
      const logo = selectedItem.getAttribute('data-logo');
      
      if (url && url !== 'null') {
        playChannel(url, logo);
        triggerSwitchAd();
      }
    }
  }

  function enterFullscreen() {
    if (player && player.core) {
      player.core.toggleFullscreen();
    }
  }

  function exitToNormalMode() {
    if (isInFullscreen && player && player.core) {
      // ‡¶´‡ßÅ‡¶≤‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßá‡¶∞ ‡¶π‡ßã‡¶®
      player.core.toggleFullscreen();
    }
    
    // ‡¶õ‡ßã‡¶ü ‡¶°‡¶ø‡¶≤‡ßá ‡¶™‡¶∞‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßã‡¶°‡ßá ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®
    setTimeout(() => {
      switchToChannelsMode();
    }, 300);
  }

  function togglePlayPause() {
    if (player) {
      if (player.isPlaying()) {
        player.pause();
      } else {
        player.play();
      }
    }
  }

  function focusOnPlayer() {
    currentMode = 'player';
    const playerElement = document.getElementById('player');
    if (playerElement) {
      playerElement.focus();
    }
    
    // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
    channelItems.forEach(item => {
      item.classList.remove('channel-selected');
      item.setAttribute('tabindex', '-1');
    });
  }

  function focusOnChannels() {
    currentMode = 'channels';
    if (channelItems.length > 0) {
      setFocus(currentFocusIndex);
    }
  }

  function switchToChannelsMode() {
    currentMode = 'channels';
    lastNormalModeTime = Date.now();
    focusOnChannels();
  }

  function handleNavigationKey(key) {
    const now = Date.now();
    
    // ‡¶ï‡ßÄ ‡¶™‡ßç‡¶∞‡ßá‡¶∏ ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    lastKeyPressTime = now;
    
    // ‡¶ï‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßã‡¶° ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®
    if (currentMode === 'channels') {
      // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßã‡¶°‡ßá, ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
      switch(key) {
        case 'ArrowUp':
          navigateUp();
          break;
        case 'ArrowDown':
          navigateDown();
          break;
        case 'ArrowLeft':
          navigateLeft();
          break;
        case 'ArrowRight':
          navigateRight();
          break;
      }
    } else if (currentMode === 'player' && !isInFullscreen) {
      // ‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶°‡ßá (‡¶®‡¶®-‡¶´‡ßÅ‡¶≤‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®), ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∞‡ßã ‡¶ï‡ßÄ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßã‡¶°‡ßá ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßá
      switch(key) {
        case 'ArrowUp':
        case 'ArrowDown':
        case 'ArrowLeft':
        case 'ArrowRight':
          switchToChannelsMode();
          break;
      }
    }
  }

  function handleSpecialKey(key) {
    switch(key) {
      case 'Enter':
      case ' ':
        handleEnterPress();
        break;
        
      case 'f':
      case 'F':
        if (player && player.core) {
          player.core.toggleFullscreen();
        }
        break;
        
      case 'p':
      case 'P':
        if (window.player && window.player.pip) {
          if (window.player.pip.isInPipMode()) {
            window.player.pip.exitPipMode();
          } else {
            window.player.pip.enterPipMode();
          }
        }
        break;
        
      case 'Escape':
      case 'Backspace':
        if (isInFullscreen) {
          // ‡¶´‡ßÅ‡¶≤‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßá‡¶∞ ‡¶π‡ßã‡¶®
          exitToNormalMode();
        } else if (currentMode === 'player') {
          // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßã‡¶°‡ßá ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®
          switchToChannelsMode();
        }
        // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßã‡¶°‡ßá, ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ (‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßã‡¶°‡ßá‡¶á ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®)
        break;
        
      case 'Tab':
        // ‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßã‡¶°‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶ü‡¶ó‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®
        if (currentMode === 'channels') {
          focusOnPlayer();
        } else {
          switchToChannelsMode();
        }
        break;
    }
  }

  function getGridColumns() {
    const container = document.querySelector('.playlist-container');
    if (!container) return 3;
    
    const computedStyle = window.getComputedStyle(container);
    const gridTemplateColumns = computedStyle.gridTemplateColumns;
    const columns = gridTemplateColumns.split(' ').length;
    
    return Math.max(columns, 3);
  }

  // TV ‡¶∞‡¶ø‡¶Æ‡ßã‡¶ü ‡¶ï‡ßÄ ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç
  function handleTVRemoteKey(event) {
    const key = event.key;
    
    // ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶ï‡ßÄ‡¶ó‡ßÅ‡¶≤‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∞‡ßã‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter', ' ', 'Escape', 'Tab', 'Backspace'].includes(key)) {
      event.preventDefault();
    }
    
    // ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶ï‡ßÄ‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
      handleNavigationKey(key);
    } else {
      handleSpecialKey(key);
    }
  }

  // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®
  document.addEventListener('DOMContentLoaded', function() {
    // ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶®‡¶æ‡¶∞ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®
    initEventListeners();
    
    // ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®
    initializeFirebase();
    
    // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®
    initImageLoading();
    
    // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
    loadChannels();
    
    // ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®
    setupSearch();
    
    // TV ‡¶∞‡¶ø‡¶Æ‡ßã‡¶ü ‡¶ï‡ßÄ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
    document.addEventListener('keydown', handleTVRemoteKey);
    
    // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßã‡¶°‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
    switchToChannelsMode();
    
    // ‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®
    document.addEventListener('click', function(e) {
      if (e.target.closest('.channel-item')) {
        const clickedItem = e.target.closest('.channel-item');
        const index = Array.from(channelItems).indexOf(clickedItem);
        if (index >= 0) {
          currentFocusIndex = index;
          setFocus(currentFocusIndex);
          selectChannel();
        }
      } else if (e.target.closest('#player') || e.target.closest('.video-wrapper')) {
        focusOnPlayer();
      }
    }, { passive: true });
    
    // ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶Ö‡¶ü‡ßã-‡¶´‡ßã‡¶ï‡¶æ‡¶∏
    setTimeout(() => {
      const channelList = document.getElementById('channelList');
      if (channelList) {
        channelList.scrollTop = 0;
      }
      switchToChannelsMode();
      
      // ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®
      initFirebaseCounters();
    }, 1000);
  });

  // ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®
  function setupSearch() {
    const searchInput = document.getElementById('channelSearch');
    const clearButton = document.getElementById('clearSearch');
    const searchResultsInfo = document.getElementById('searchResultsInfo');
    
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.trim().toLowerCase();
      
      if (searchTerm.length > 0) {
        isSearchActive = true;
        clearButton.style.display = 'block';
        filterChannels(searchTerm);
      } else {
        isSearchActive = false;
        clearButton.style.display = 'none';
        clearSearch();
      }
    }, { passive: true });
    
    clearButton.addEventListener('click', function() {
      searchInput.value = '';
      isSearchActive = false;
      clearButton.style.display = 'none';
      clearSearch();
      switchToChannelsMode();
    });
    
    // ‡¶ï‡ßÄ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶∂‡¶∞‡ßç‡¶ü‡¶ï‡¶æ‡¶ü (Ctrl+F) ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶ï‡¶∞‡¶§‡ßá
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        searchInput.focus();
      }
      
      // / ‡¶ï‡ßÄ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶®
      if (e.key === '/' && document.activeElement !== searchInput) {
        e.preventDefault();
        searchInput.focus();
      }
    }, { passive: false });
  }
  
  // ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ü‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
  function filterChannels(searchTerm) {
    filteredChannels = channels.filter(channel => 
      channel.name.toLowerCase().includes(searchTerm)
    );
    
    renderFilteredChannels();
    
    const searchResultsInfo = document.getElementById('searchResultsInfo');
    if (filteredChannels.length === 0) {
      searchResultsInfo.textContent = `No channels found for "${searchTerm}"`;
      searchResultsInfo.style.display = 'block';
    } else {
      searchResultsInfo.textContent = `Found ${filteredChannels.length} channel(s) for "${searchTerm}"`;
      searchResultsInfo.style.display = 'block';
    }
  }
  
  // ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶¨ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
  function clearSearch() {
    const searchResultsInfo = document.getElementById('searchResultsInfo');
    searchResultsInfo.style.display = 'none';
    renderChannels();
    switchToChannelsMode();
  }
  
  // ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶° ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
  function renderFilteredChannels() {
    const channelList = document.getElementById('channelList');
    
    if (filteredChannels.length === 0) {
      channelList.innerHTML = '<div class="loading">No channels found</div>';
      channelItems = [];
      return;
    }
    
    let html = '<div class="playlist-container">';
    
    filteredChannels.forEach((channel, index) => {
      html += `
        <div class="channel-item" 
             data-url="${channel.url}" 
             data-logo="${channel.logo}"
             data-index="${index}"
             tabindex="-1">
          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 70'%3E%3Crect width='100' height='70' fill='%23222'/%3E%3C/svg%3E"
               data-src="${channel.logo}" 
               onerror="this.src='https://i.postimg.cc/d1hHy4ss/11.png'; this.onerror=null;" 
               class="channel-logo">
          <div class="channel-name">${channel.name}</div>
        </div>
      `;
    });
    
    html += '</div>';
    
    channelList.innerHTML = html;
    
    // ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶° ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡¶ó‡ßÅ‡¶≤‡¶ø‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
    const channelItems = document.querySelectorAll('.channel-item');
    channelItems.forEach((item, index) => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        currentFocusIndex = index;
        setFocus(currentFocusIndex);
        const url = this.getAttribute('data-url');
        const logo = this.getAttribute('data-logo');
        playChannel(url, logo);
        triggerSwitchAd();
        focusOnPlayer();
      }, { passive: false });
    });
    
    // ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    updateChannelItems();
    switchToChannelsMode();
    
    setTimeout(() => {
      channelList.scrollTop = 0;
    }, 100);
  }

  // ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
  async function loadChannels() {
    try {
      channels = [];
      playlistSources = [];
      filteredChannels = [];
      
      let startIndex = 0;
      
      const playlists = [
        { url: m3u1Url, name: "SiromeTV" },
        { url: m3u2Url, name: "Sports" },
        { url: m3u3Url, name: "Ayna" },
        { url: m3u4Url, name: "Yupp" },
        { url: m3u5Url, name: "CricHd" },
        { url: m3u6Url, name: "CricHd" }
      ];
      
      for (let i = 0; i < playlists.length; i++) {
        const playlist = playlists[i];
        const m3uChannels = await loadM3uPlaylist(playlist.url);
        
        if (m3uChannels && m3uChannels.length > 0) {
          playlistSources.push({
            name: playlist.name,
            startIndex: startIndex,
            count: m3uChannels.length
          });
          
          channels = channels.concat(m3uChannels);
          startIndex += m3uChannels.length;
        }
      }
      
      renderChannels();
      
      if (channels.length > 0) {
        initPlayer(channels[0].url, channels[0].logo);
      }
    } catch (error) {
      console.error('Error loading channels:', error);
      document.getElementById('channelList').innerHTML = '<div class="loading">Error loading channels. Please try again later.</div>';
    }
  }

  // M3U ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
  async function loadM3uPlaylist(url) {
    try {
      const response = await fetch(url);
      const text = await response.text();
      
      const channels = [];
      const lines = text.split('\n');
      
      let currentChannel = {};
      let urlLines = [];
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (line.startsWith('#EXTINF:')) {
          const info = line.substring(8);
          const nameMatch = info.match(/,(.*)/);
          const logoMatch = info.match(/tvg-logo="([^"]*)"/);
          
          if (nameMatch) {
            currentChannel.name = nameMatch[1].trim();
          }
          
          if (logoMatch) {
            currentChannel.logo = logoMatch[1];
          } else {
            currentChannel.logo = 'https://i.postimg.cc/d1hHy4ss/11.png';
          }
          
          urlLines = [];
        } else if (line && !line.startsWith('#') && currentChannel.name) {
          urlLines.push(line);
          
          const nextLine = i + 1 < lines.length ? lines[i + 1].trim() : '';
          if (!nextLine.startsWith('#EXTINF:') && nextLine && !nextLine.startsWith('#')) {
            continue;
          } else {
            if (urlLines.length === 1) {
              currentChannel.url = urlLines[0];
              channels.push({...currentChannel});
            } else {
              for (let j = 0; j < urlLines.length; j++) {
                const numberedChannel = {
                  ...currentChannel,
                  name: `${currentChannel.name} ${j+1}`,
                  url: urlLines[j]
                };
                channels.push(numberedChannel);
              }
            }
            currentChannel = {};
          }
        }
      }
      
      return channels;
    } catch (error) {
      console.error('Error loading M3U playlist:', error);
      return [];
    }
  }

  // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡¶ó‡ßÅ‡¶≤‡¶ø‡¶ï‡ßá DOM-‡¶è ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶°‡¶æ‡¶∞ ‡¶∏‡¶π)
  function renderChannels() {
    const channelList = document.getElementById('channelList');
    
    if (channels.length === 0) {
      channelList.innerHTML = '<div class="loading">No channels available</div>';
      channelItems = [];
      return;
    }
    
    let html = '<div class="playlist-container">';
    
    channels.forEach((channel, index) => {
      for (let i = 1; i < playlistSources.length; i++) {
        if (index === playlistSources[i].startIndex) {
          html += `<div class="playlist-divider"></div>`;
          break;
        }
      }
      
      html += `
        <div class="channel-item" 
             data-url="${channel.url}" 
             data-logo="${channel.logo}"
             data-index="${index}"
             tabindex="-1">
          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 70'%3E%3Crect width='100' height='70' fill='%23222'/%3E%3C/svg%3E"
               data-src="${channel.logo}" 
               onerror="this.src='https://i.postimg.cc/d1hHy4ss/11.png'; this.onerror=null;" 
               class="channel-logo">
          <div class="channel-name">${channel.name}</div>
        </div>
      `;
    });
    
    html += '</div>';
    
    channelList.innerHTML = html;
    
    // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡¶ó‡ßÅ‡¶≤‡¶ø‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
    const channelItems = document.querySelectorAll('.channel-item');
    channelItems.forEach((item, index) => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        currentFocusIndex = index;
        setFocus(currentFocusIndex);
        const url = this.getAttribute('data-url');
        const logo = this.getAttribute('data-logo');
        playChannel(url, logo);
        triggerSwitchAd();
        focusOnPlayer();
      }, { passive: false });
    });
    
    // ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    updateChannelItems();
    switchToChannelsMode();
    
    setTimeout(() => {
      channelList.scrollTop = 0;
    }, 100);
  }

  // ‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®
  function initPlayer(url, logo) {
    // PIP ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
    if (!document.pictureInPictureEnabled) {
      console.warn('PIP mode not supported in this browser');
    }
    
    player = new Clappr.Player({
      source: url,
      parentId: "#player",
      autoPlay: true,
      mute: false,
      width: "100%",
      height: "100%",
      plugins: [
        HlsjsPlayback, 
        LevelSelector,
        window.ClapprPipMode ? window.ClapprPipMode.PipButton : null,
        FullscreenLogoPlugin
      ].filter(Boolean),
      mediacontrol: { 
        seekbar: "#0a60f5", 
        buttons: "white" 
      },
      poster: "https://i.pinimg.com/originals/5a/93/4e/5a934e84f67d2a61a118ec95b1d6cb74.gif"
    });

    // ‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤‡¶ø ‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
    window.player = player;

    // ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶≤‡ßá ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
    player.on('play', function() {
      const posterElement = document.querySelector('.poster');
      if (posterElement) {
        posterElement.style.opacity = '0';
        setTimeout(() => {
          posterElement.style.display = 'none';
        }, 1000);
      }
    });
    
    // PIP ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶®‡¶æ‡¶∞
    if (player.pip) {
      player.on('pip:enter', function() {
        console.log('PIP mode activated');
      });
      
      player.on('pip:exit', function() {
        console.log('PIP mode deactivated');
      });
    }
    
    // ‡¶´‡ßÅ‡¶≤‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶≤‡ßã‡¶ó‡ßã ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®
    const logoElement = document.getElementById('fullscreen-logo');
    if (logoElement) {
      logoElement.style.display = 'none';
      logoElement.style.opacity = '0';
    }
  }

  // ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶™‡ßç‡¶≤‡ßá ‡¶ï‡¶∞‡ßÅ‡¶®
  function playChannel(url, logo) {
    if (player) {
      player.load(url);
      player.configure({ 
        autoPlay: true, 
        poster: "https://i.postimg.cc/cJBhWxv5/3122396-icoCopy.png"
      });
    } else {
      initPlayer(url, logo);
    }
  }

  // ‡¶è‡¶° ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ü‡ßç‡¶∞‡¶ø‡¶ó‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
  function triggerSwitchAd() {
    const now = Date.now();
    const adCooldown = 120000;
    if (now - lastAdTime < adCooldown) return;
    lastAdTime = now;
    if (typeof show_9978881 === 'function') {
      show_9978881();
      incrementAdShown();
    }
  }

  let lastAdTime = 0;

  function incrementAdShown() {
    if (window.db) {
      const adsRef = db.ref("adsStats");
      adsRef.child("totalShown").transaction(c => (c || 0) + 1);
    }
  }

  function incrementAdClicked() {
    if (window.db) {
      const adsRef = db.ref("adsStats");
      adsRef.child("totalClicked").transaction(c => (c || 0) + 1);
    }
  }
  
  // ‡¶®‡¶§‡ßÅ‡¶® Monetag ‡¶ú‡ßã‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
  if (typeof window.show_9978881_click_callback === 'undefined') {
    window.show_9978881_click_callback = incrementAdClicked;
  }
</script>

</body>
</html>
